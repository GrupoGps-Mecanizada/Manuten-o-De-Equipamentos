<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GrupoGPS Mecanizada - Sistema de Dupla Checagem de Manutenção</title>

  <link rel="icon" href="data:,">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="js/advancedReports.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">


  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/enhanced-style.css">
  
  </head>

<body>
  <div class="container">
    <div class="header">
      <div class="company-logo">Grupo GPS</div>
      <h1>Sistema de Controle de Manutenção</h1>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="maintenance">Manutenções</div>
      <div class="tab" data-tab="verification">Verificações</div>
      <div class="tab" data-tab="reports">Relatórios</div>
    </div>

    <div class="tab-content active" id="tab-dashboard">
      <div class="dashboard-header">
        <h2>Visão Geral</h2>
        </div>

      <div class="summary-cards">
        <div class="card">
          <div class="card-title">
            <i class="icon fas fa-clipboard-list"></i> Total de Manutenções
          </div>
          <div class="card-value" id="total-maintenance">0</div> <div class="card-footer">
            <span>Período selecionado</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <i class="icon fas fa-clock"></i> Aguardando Verificação
          </div>
          <div class="card-value" id="pending-verification">0</div> <div class="card-footer">
            <span>Precisa de atenção</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <i class="icon fas fa-check-circle"></i> Verificações Concluídas
          </div>
          <div class="card-value" id="completed-verifications">0</div> <div class="card-footer">
            <span>Período atual</span>
            </div>
        </div>

        <div class="card">
          <div class="card-title">
            <i class="icon fas fa-exclamation-triangle"></i> Manutenções Críticas
          </div>
          <div class="card-value" id="critical-maintenance">0</div> <div class="card-footer">
            <span>Atenção necessária</span>
          </div>
        </div>
      </div>

      <div class="grid-container">
        <div class="section">
          <h3 class="section-title">
            Manutenções por Tipo
            </h3>
          <div class="chart-container">
            <canvas id="maintenance-type-chart"></canvas>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">
            Status das Manutenções
            </h3>
          <div class="chart-container">
            <canvas id="maintenance-status-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">Análises Avançadas</h3>

        <div class="grid-container">
          <div class="section sub-section">
            <h4 class="section-title">
              Local de Manutenção
              </h4>
            <div class="chart-container">
              <canvas id="area-distribution-chart"></canvas>
            </div>
          </div>

          <div class="section sub-section">
            <h4 class="section-title">
              Categorias de Problemas
              </h4>
            <div class="chart-container">
              <canvas id="problem-categories-chart"></canvas>
            </div>
          </div>
        </div>

        <div class="grid-container">
          <div class="section sub-section">
            <h4 class="section-title">
              Tendência Mensal
             </h4>
            <div class="chart-container">
              <canvas id="monthly-trend-chart"></canvas>
            </div>
          </div>

          <div class="section sub-section">
            <h4 class="section-title">
              Manutenções Críticas vs Regulares
              </h4>
            <div class="chart-container">
              <canvas id="critical-vs-regular-chart"></canvas>
            </div>
          </div>
        </div>

        <div class="grid-container">
          <div class="section sub-section">
            <h4 class="section-title">
              Resultados das Verificações
              </h4>
            <div class="chart-container">
              <canvas id="verification-results-chart"></canvas>
            </div>
          </div>

          <div class="section sub-section">
            <h4 class="section-title">
              Intervalo entre Manutenções
              </h4>
            <div class="chart-container">
              <canvas id="maintenance-frequency-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">
          Equipamentos com Mais Manutenções
          </h3>
        <div class="table-responsive">
          <table id="equipment-ranking-table">
            <thead>
              <tr>
                <th>Equipamento</th>
                <th>Tipo</th>
                <th>Total Manutenções</th>
                <th>Última Manutenção</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="equipment-ranking-tbody">
              </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">Manutenções Recentes</h3>
        <div class="table-responsive">
          <table id="recent-maintenance-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Equipamento</th>
                <th>Tipo</th>
                <th>Data Registro</th>
                <th>Responsável</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="recent-maintenance-tbody">
              </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-maintenance">
        <div class="section">
           <div class="search-container">
             <input type="text" class="search-input" id="maintenance-search" placeholder="Buscar por ID, equipamento, responsável...">
           </div>

           <div class="filter-container" id="maintenance-filter-buttons"> </div>

           <h3 class="section-title">
             Lista de Manutenções
             <div class="section-actions">
               <button class="btn-icon" id="refresh-maintenance-list" title="Atualizar">↻</button>
             </div>
           </h3>

           <div class="table-responsive">
             <table id="maintenance-table">
               <thead>
                 <tr>
                   <th>ID</th>
                   <th>Equipamento</th>
                   <th>Tipo</th>
                   <th>Data Registro</th>
                   <th>Responsável</th>
                   <th>Área</th>
                   <th>Local/Oficina</th>
                   <th>Problema</th>
                   <th>Status</th>
                   <th>Ações</th>
                 </tr>
               </thead>
               <tbody id="maintenance-tbody">
                 </tbody>
             </table>
           </div>
           <div class="pagination-controls" id="maintenance-pagination">
              </div>
         </div>
    </div>

    <div class="tab-content" id="tab-verification">
       <div class="section">
          <div class="search-container">
            <input type="text" class="search-input" id="verification-search" placeholder="Buscar por ID, equipamento, responsável...">
          </div>

          <div class="filter-container" id="verification-filter-buttons">
             </div>

          <h3 class="section-title">
            Verificações Pendentes
            <div class="section-actions">
              <button class="btn-icon" id="refresh-verification-list" title="Atualizar">↻</button>
            </div>
          </h3>

          <div class="table-responsive">
            <table id="verification-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Equipamento</th>
                  <th>Tipo</th>
                  <th>Data Manutenção</th>
                  <th>Responsável</th>
                  <th>Área</th>
                  <th>Local/Oficina</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="verification-tbody">
                </tbody>
            </table>
          </div>
           <div class="pagination-controls" id="verification-pagination">
              </div>
        </div>
    </div>

    <div class="tab-content" id="tab-reports">
       <div class="section">
         <h3 class="section-title">Relatórios por Período</h3>
         <div class="form-row">
           <div class="form-col">
             <div class="form-group">
               <label for="report-start-date">Data Inicial</label>
               <input type="date" class="form-control" id="report-start-date">
             </div>
           </div>
           <div class="form-col">
             <div class="form-group">
               <label for="report-end-date">Data Final</label>
               <input type="date" class="form-control" id="report-end-date">
             </div>
           </div>
           <div class="form-col" style="display: flex; align-items: flex-end;">
             <button class="btn" id="generate-report">Gerar Relatório</button>
           </div>
         </div>
       </div>

       <div id="report-content" style="display: none;">
         <div class="section">
           <h3 class="section-title">Resumo do Período</h3>
           <div class="summary-cards">
             <div class="card">
               <div class="card-title">Total de Manutenções</div>
               <div class="card-value" id="report-total">0</div>
             </div>
             <div class="card">
               <div class="card-title">Concluídas</div>
               <div class="card-value" id="report-completed">0</div>
             </div>
             <div class="card">
               <div class="card-title">Pendentes</div>
               <div class="card-value" id="report-pending">0</div>
             </div>
             <div class="card">
               <div class="card-title">Verificadas</div>
               <div class="card-value" id="report-verified">0</div>
             </div>
           </div>
         </div>

         <div class="section">
           <h3 class="section-title">Análise por Categoria de Problema</h3>
           <div class="chart-container">
             <canvas id="report-problem-chart"></canvas>
           </div>
         </div>

         <div class="grid-container">
           <div class="section">
             <h3 class="section-title">Distribuição por Área</h3>
             <div class="chart-container">
               <canvas id="report-area-chart"></canvas>
             </div>
           </div>

           <div class="section">
             <h3 class="section-title">Manutenções por Mês</h3>
             <div class="chart-container">
               <canvas id="report-monthly-chart"></canvas>
             </div>
           </div>
         </div>

         <div class="section">
           <h3 class="section-title">Exportar Dados</h3>
           <div class="btn-action-group">
             <button class="btn" id="export-excel">Exportar para Excel</button>
             <button class="btn" id="export-pdf">Exportar para PDF</button>
             <button class="btn" id="print-report">Imprimir Relatório</button>
           </div>
         </div>
       </div>
     </div>

    <div class="form-overlay" id="maintenance-form-overlay">
      <div class="form-container">
          <div class="form-header">
            <h2 class="form-title">Registrar Nova Manutenção</h2>
            <button class="form-close" id="close-maintenance-form">×</button>
          </div>

          <div class="form-steps">
            <div class="form-step active" data-step="1">
              <div class="step-number">1</div>
              <div class="step-label">Informações</div>
            </div>
            <div class="form-step" data-step="2">
              <div class="step-number">2</div>
              <div class="step-label">Problema</div>
            </div>
            <div class="form-step" data-step="3">
              <div class="step-number">3</div>
              <div class="step-label">Confirmar</div>
            </div>
          </div>

          <form id="maintenance-form">
            <div class="form-step-content" id="step-1-content">
              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="equipment-type">Tipo de Equipamento <span class="form-required">*</span></label>
                    <select class="form-control" id="equipment-type" name="equipment-type" required>
                      <option value="">Selecione o tipo...</option>
                      </select>
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group">
                    <label for="equipment-id">Placa ou ID <span class="form-required">*</span></label>
                    <select class="form-control" id="equipment-id" name="equipment-id" required>
                      <option value="">Selecione o equipamento...</option>
                      </select>
                  </div>
                </div>
              </div>

              <div class="form-group" id="other-equipment-field" style="display:none;">
                <label for="other-equipment">Especifique Equipamento <span class="form-required">*</span></label>
                <input type="text" class="form-control" id="other-equipment" name="other-equipment">
              </div>

              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="technician-name">Responsável pelo Relatório <span class="form-required">*</span></label>
                    <input type="text" class="form-control" id="technician-name" name="technician-name" required>
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group">
                    <label for="maintenance-date">Data da Manutenção <span class="form-required">*</span></label>
                    <input type="date" class="form-control" id="maintenance-date" name="maintenance-date" required>
                  </div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="area">Área <span class="form-required">*</span></label>
                    <select class="form-control" id="area" name="area" required>
                      <option value="">Selecione...</option>
                      <option value="Área Interna Usiminas">Área Interna Usiminas</option>
                      <option value="Área Externa Usiminas">Área Externa Usiminas</option>
                    </select>
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group" id="office-field">
                    <label for="office">Local/Oficina <span class="form-required">*</span></label>
                    <input type="text" class="form-control" id="office" name="office" required>
                  </div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="maintenance-type-select">Tipo de Manutenção <span class="form-required">*</span></label> <select class="form-control" id="maintenance-type-select" name="maintenance-type-select" required>
                      <option value="">Selecione o tipo...</option>
                      <option value="Preventiva">Preventiva</option>
                      <option value="Corretiva">Corretiva</option>
                      <option value="Emergencial">Emergencial</option>
                    </select>
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group">
                    <div class="form-check" style="padding-top: 30px;">
                      <input type="checkbox" id="is-critical" name="is-critical">
                      <label for="is-critical">Manutenção Crítica (requer atenção imediata)</label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-navigation">
                <button type="button" class="btn" id="cancel-maintenance">Cancelar</button>
                <button type="button" class="btn btn-success" id="next-to-step-2">Próximo</button>
              </div>
            </div>

            <div class="form-step-content" id="step-2-content" style="display: none;">
              <div class="form-group">
                <label for="problem-category">Categoria do Problema <span class="form-required">*</span></label>
                <select class="form-control" id="problem-category-select" name="problem-category-select" required> <option value="">Selecione a categoria...</option>
                  </select>
              </div>

              <div class="form-group" id="other-category-field" style="display:none;">
                <label for="other-category">Especifique Categoria <span class="form-required">*</span></label>
                <input type="text" class="form-control" id="other-category" name="other-category">
              </div>

              <div class="form-group">
                <label for="problem-description">Detalhes do Problema <span class="form-required">*</span></label>
                <textarea class="form-control" id="problem-description" name="problem-description" rows="4" required></textarea>
              </div>

              <div class="form-group">
                <label for="additional-notes">Observações Adicionais</label>
                <textarea class="form-control" id="additional-notes" name="additional-notes" rows="3"></textarea>
              </div>

              <div class="form-navigation">
                <button type="button" class="btn" id="back-to-step-1">Voltar</button>
                <button type="button" class="btn btn-success" id="next-to-step-3">Próximo</button>
              </div>
            </div>

            <div class="form-step-content" id="step-3-content" style="display: none;">
              <div class="form-group">
                <h3>Resumo da Manutenção</h3>
                <div class="summary-content">
                  <div class="summary-row">
                    <div class="summary-label">Equipamento:</div>
                    <div class="summary-value" id="summary-equipment"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Responsável:</div>
                    <div class="summary-value" id="summary-technician"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Data:</div>
                    <div class="summary-value" id="summary-date"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Local:</div>
                    <div class="summary-value" id="summary-location"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Tipo:</div>
                    <div class="summary-value" id="summary-type"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">É Crítica:</div>
                    <div class="summary-value" id="summary-critical"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Categoria de Problema:</div>
                    <div class="summary-value" id="summary-category"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Detalhes do Problema:</div>
                    <div class="summary-value" id="summary-problem"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Observações:</div>
                    <div class="summary-value" id="summary-notes"></div>
                  </div>
                </div>
              </div>

              <div class="form-navigation">
                <button type="button" class="btn" id="back-to-step-2">Voltar</button>
                <button type="submit" class="btn btn-success" id="submit-maintenance">Finalizar Registro</button>
              </div>
            </div>
          </form>
        </div>
    </div>

    <div class="form-overlay" id="verification-form-overlay">
      <div class="form-container">
          <div class="form-header">
            <h2 class="form-title">Verificação de Manutenção</h2>
            <button class="form-close" id="close-verification-form">×</button>
          </div>

          <form id="verification-form">
            <div class="form-group">
              <label for="verification-id">ID da Manutenção</label>
              <input type="text" class="form-control" id="verification-id" name="verification-id" readonly>
            </div>

            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="verification-equipment">Equipamento</label>
                  <input type="text" class="form-control" id="verification-equipment" readonly>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="verification-type">Tipo de Manutenção</label>
                  <input type="text" class="form-control" id="verification-type" readonly>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="verifier-name">Nome do Verificador <span class="form-required">*</span></label>
              <input type="text" class="form-control" id="verifier-name" name="verifier-name" required>
            </div>

            <div class="form-group">
              <label>Resultado da Verificação <span class="form-required">*</span></label>
              <div class="form-check">
                <input type="radio" id="verification-approved" name="verification-result" value="Aprovado" required>
                <label for="verification-approved">Aprovado - Manutenção Correta</label>
              </div>
              <div class="form-check">
                <input type="radio" id="verification-adjustments" name="verification-result" value="Ajustes" required>
                <label for="verification-adjustments">Necessita Ajustes Menores</label>
              </div>
              <div class="form-check">
                <input type="radio" id="verification-rejected" name="verification-result" value="Reprovado" required>
                <label for="verification-rejected">Reprovado - Precisa de Nova Manutenção</label>
              </div>
            </div>

            <div class="form-group">
              <label for="verification-comments">Comentários da Verificação <span class="form-required">*</span></label>
              <textarea class="form-control" id="verification-comments" name="verification-comments" rows="4" required></textarea>
            </div>

            <div class="form-navigation">
              <button type="button" class="btn" id="cancel-verification">Cancelar</button>
              <button type="submit" class="btn btn-success" id="submit-verification">Finalizar Verificação</button>
            </div>
          </form>
        </div>
    </div>

    <div class="form-overlay" id="detail-overlay">
      <div class="form-container">
          <div class="form-header">
            <h2 class="form-title">Detalhes da Manutenção</h2>
            <button class="form-close" id="close-detail">×</button>
          </div>

          <div class="maintenance-detail" id="maintenance-detail-content">
            </div>

          <div class="form-navigation">
            <button class="btn" id="close-detail-btn">Fechar</button>
            <button class="btn btn-success" id="verify-maintenance-btn">Verificar Manutenção</button>
          </div>
        </div>
    </div>

    <div id="notification-container"></div>

    <div class="btn-new" id="new-maintenance">+</div>

    <div class="footer">
      <p>Sistema de Dupla Checagem de Manutenção © 2025 | Última atualização: <span id="last-update">Carregando...</span></p>
      <p class="developer-credit">Desenvolvido por Warlison Abreu</p>
    </div>
  </div>

  <div id="global-loader" style="display: none;">
    <div class="loader-spinner"></div>
    <div id="global-loader-message">Carregando...</div>
  </div>

<script>
// Configurações do sistema
const scriptConfig = {
  baseUrl: '', // URL base para os scripts, deixe vazio se estiverem na mesma pasta que o HTML
  scripts: [
    {name: 'api', path: 'js/api.js', required: true},
    {name: 'utilities', path: 'js/utilities.js', required: true},
    {name: 'dashboard', path: 'js/dashboard.js', depends: ['api', 'utilities']},
    {name: 'maintenance', path: 'js/maintenance.js', depends: ['api', 'utilities']},
    {name: 'verification', path: 'js/verification.js', depends: ['api', 'utilities']},
    {name: 'reports', path: 'js/reports.js', depends: ['api', 'utilities']},
    {name: 'main', path: 'js/main.js', depends: ['api', 'utilities']}
  ],
  maxRetries: 3,
  timeout: 15000 // Aumentado para 15 segundos
};

// Sistema de carregamento de scripts com retentativas
const ScriptLoader = {
  loadedScripts: {},
  pendingScripts: {},

  init: function() {
    console.log("Iniciando carregamento das dependências...");
    // Primeiro carregar as dependências essenciais
    this.loadCoreScriptsSequentially();
  },

  loadCoreScriptsSequentially: function() {
    // Identificar scripts essenciais
    const coreScripts = scriptConfig.scripts.filter(s => s.required);

    console.log("Carregando scripts essenciais sequencialmente...");
    // Carregar primeiro script
    if (coreScripts.length > 0) {
      this.loadScriptSequential(coreScripts, 0, () => {
        console.log("Scripts essenciais carregados. Verificando flags...");

        // Verificar flags após carregar todos os scripts essenciais
        setTimeout(() => {
          // Verificar se as flags estão definidas
          const apiLoaded = (window.API !== undefined) && window.API_LOADED;
          const utilitiesLoaded = (window.Utilities !== undefined) && window.UTILITIES_LOADED;

          if (!apiLoaded) {
            console.warn("API não foi carregada corretamente!");
          }
          if (!utilitiesLoaded) {
            console.warn("Utilities não foram carregadas corretamente!");
          }

          // Continuar mesmo com problemas (o sistema tentará recuperar)
          this.loadRemainingScripts();
        }, 100); // Pequeno timeout para garantir que flags sejam definidas
      });
    } else {
      this.loadRemainingScripts();
    }
  },

  loadScriptSequential: function(scripts, index, onComplete) {
    if (index >= scripts.length) {
      if (typeof onComplete === 'function') {
        onComplete();
      }
      return;
    }

    const script = scripts[index];
    console.log(`Carregando script essencial: ${script.name}`);

    this.loadScript(script.name, script.path)
      .then(() => {
        // Verifica se o script foi realmente carregado
        const scriptLoaded = this.checkScriptLoaded(script.name);
        if (!scriptLoaded) {
          console.warn(`Script ${script.name} não foi carregado corretamente.`);
        }

        // Um pequeno intervalo para garantir que o script seja processado
        setTimeout(() => {
          this.loadScriptSequential(scripts, index + 1, onComplete);
        }, 100);
      })
      .catch(error => {
        console.error(`Erro ao carregar script essencial ${script.name}:`, error);
        // Continua mesmo com erro (menos crítico, o sistema tentará recuperar)
        setTimeout(() => {
          this.loadScriptSequential(scripts, index + 1, onComplete);
        }, 100);
      });
  },

  checkScriptLoaded: function(name) {
    // Verifica se o script foi carregado corretamente
    if (name === 'api') {
      return window.API !== undefined;
    } else if (name === 'utilities') {
      return window.Utilities !== undefined;
    }
    return this.loadedScripts[name] === true;
  },

  loadRemainingScripts: function() {
    // Filtrar scripts que não são essenciais
    const remainingScripts = scriptConfig.scripts.filter(s => !s.required);

    // Carregar scripts sequencialmente para garantir dependências
    console.log("Carregando scripts restantes...");
    this.loadScriptsSequentially(remainingScripts, 0, () => {
      console.log("Todos os scripts (essenciais e restantes) foram carregados.");
      this.initializeSystem();
    });
  },

  loadScriptsSequentially: function(scripts, index, onComplete) {
    if (index >= scripts.length) {
      if (typeof onComplete === 'function') {
        onComplete();
      }
      return;
    }

    const script = scripts[index];

    // Verificar dependências antes de tentar carregar
    if (script.depends && script.depends.length > 0) {
      const allDependenciesLoaded = script.depends.every(dep => {
        // Verifica explicitamente cada dependência
        if (dep === 'api' && !window.API) {
          console.warn("Dependência API não está disponível para " + script.name);
          return false;
        }
        if (dep === 'utilities' && !window.Utilities) {
          console.warn("Dependência Utilities não está disponível para " + script.name);
          return false;
        }
        return this.loadedScripts[dep];
      });

      if (!allDependenciesLoaded) {
        console.warn(`Dependências para ${script.name} não estão carregadas. Adiando carregamento.`);
        // Adiar o carregamento e tentar novamente mais tarde
        setTimeout(() => {
          this.loadScriptsSequentially(scripts, index, onComplete);
        }, 300);
        return;
      }
    }

    this.loadScript(script.name, script.path)
      .then(() => {
        this.loadScriptsSequentially(scripts, index + 1, onComplete);
      })
      .catch((error) => {
        console.error(`Erro ao carregar script ${script.name}:`, error);
        // Continua carregando os outros scripts
        this.loadScriptsSequentially(scripts, index + 1, onComplete);
      });
  },

  loadScript: function(name, path, retryCount = 0) {
    // Se o script já foi carregado, retorne imediatamente.
    if (this.loadedScripts[name]) {
      return Promise.resolve();
    }

    // Se o script já está sendo carregado (pendente), retorne a promise existente.
    if (this.pendingScripts[name]) {
      return this.pendingScripts[name];
    }

    const url = scriptConfig.baseUrl + path;
    console.log(`Iniciando carregamento de: ${name} (${url})`);

    // Criar nova promise para carregar o script
    const promise = new Promise((resolve, reject) => {
      const scriptElement = document.createElement('script');
      scriptElement.src = url;
      scriptElement.async = true;

      let timeoutId = null;

      // Função para limpar recursos
      const cleanup = () => {
        clearTimeout(timeoutId);
        scriptElement.onload = null;
        scriptElement.onerror = null;
      };

      // Configurar timeout
      timeoutId = setTimeout(() => {
        console.error(`Timeout ao carregar ${name} (${url}) após ${scriptConfig.timeout}ms`);
        scriptElement.remove();
        delete this.pendingScripts[name];

        if (retryCount < scriptConfig.maxRetries) {
          console.log(`Tentando carregar ${name} novamente (tentativa ${retryCount + 1}/${scriptConfig.maxRetries})...`);
          this.loadScript(name, path, retryCount + 1)
            .then(resolve)
            .catch(reject);
        } else {
          cleanup();
          reject(new Error(`Falha ao carregar ${name} após ${scriptConfig.maxRetries} tentativas (timeout)`));
        }
      }, scriptConfig.timeout);

      // Evento de sucesso
      scriptElement.onload = () => {
        console.log(`Script ${name} (${path}) carregado com sucesso.`);
        cleanup();
        this.loadedScripts[name] = true;
        delete this.pendingScripts[name];
        resolve();
      };

      // Evento de erro
      scriptElement.onerror = (event) => {
        console.error(`Erro ao carregar ${name} (${url})`, event);
        scriptElement.remove();
        delete this.pendingScripts[name];

        if (retryCount < scriptConfig.maxRetries) {
          console.log(`Tentando carregar ${name} novamente (tentativa ${retryCount + 1}/${scriptConfig.maxRetries})...`);
          setTimeout(() => {
            this.loadScript(name, path, retryCount + 1)
              .then(resolve)
              .catch(reject);
          }, 500 * (retryCount + 1));
        } else {
          cleanup();
          reject(new Error(`Falha ao carregar ${name} (${url}) após ${scriptConfig.maxRetries} tentativas`));
        }
      };

      // Adicionar ao body para iniciar o carregamento
      document.body.appendChild(scriptElement);
    });

    // Armazena a promise enquanto o script está carregando
    this.pendingScripts[name] = promise;
    return promise;
  },

  initializeSystem: function() {
    console.log("Tentando inicializar o sistema...");
    const loader = document.getElementById('global-loader');
    if (loader) loader.style.display = 'flex';

    try {
      // Tenta chamar a função global de inicialização
      if (typeof window.initializeApp === 'function') {
        window.initializeApp();
        console.log("Sistema inicializado via window.initializeApp().");
      } else if (typeof initializeApp === 'function') { // Fallback
        initializeApp();
        console.log("Sistema inicializado via initializeApp().");
      } else {
        console.error("Função de inicialização 'initializeApp' não encontrada. A aplicação pode não funcionar corretamente.");
        // Tentar inicializar componentes individuais como fallback
        this.initializeComponentsFallback();
      }
    } catch (error) {
      console.error("Erro GERAL durante a inicialização do sistema:", error);
      this.showErrorMessage();
    } finally {
      setTimeout(() => {
        if (loader) loader.style.display = 'none';
      }, 200);
    }
  },

  initializeComponentsFallback: function() {
    console.warn("Tentando inicializar componentes individuais como fallback...");
    let initializedSomething = false;

    // Tenta inicializar componentes comuns
    if (typeof Dashboard !== 'undefined' && typeof Dashboard.initialize === 'function') {
      try {
        Dashboard.initialize();
        console.log("Dashboard inicializado (fallback).");
        initializedSomething = true;
      } catch (e) { console.error("Erro ao inicializar Dashboard (fallback):", e); }
    }

    if (typeof Maintenance !== 'undefined' && typeof Maintenance.initialize === 'function') {
      try {
        Maintenance.initialize();
        console.log("Maintenance inicializado (fallback).");
        initializedSomething = true;
      } catch (e) { console.error("Erro ao inicializar Maintenance (fallback):", e); }
    }

    if (typeof Verification !== 'undefined' && typeof Verification.initialize === 'function') {
      try {
        Verification.initialize();
        console.log("Verification inicializado (fallback).");
        initializedSomething = true;
      } catch (e) { console.error("Erro ao inicializar Verification (fallback):", e); }
    }

    if (typeof Reports !== 'undefined' && typeof Reports.initialize === 'function') {
      try {
        Reports.initialize();
        console.log("Reports inicializado (fallback).");
        initializedSomething = true;
      } catch (e) { console.error("Erro ao inicializar Reports (fallback):", e); }
    }

    if (!initializedSomething) {
      console.error("Nenhum componente pôde ser inicializado via fallback.");
      this.showErrorMessage();
    }
  },

  showErrorMessage: function() {
    // Garante que não haja múltiplas mensagens de erro
    if (document.getElementById('script-load-error-message')) {
      return;
    }

    // Criar mensagem de erro visível
    const errorDiv = document.createElement('div');
    errorDiv.id = 'script-load-error-message';
    errorDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #ffebe6;
      color: #bf2600;
      padding: 25px;
      border: 1px solid #ffbdad;
      border-radius: 8px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      z-index: 10000;
      max-width: 90%;
      width: 450px;
      text-align: center;
      font-family: sans-serif;
    `;

    errorDiv.innerHTML = `
      <h2 style="color: #bf2600; margin-top: 0; margin-bottom: 15px; font-size: 1.3em;">Erro ao Carregar o Sistema</h2>
      <p style="margin-bottom: 20px; line-height: 1.5; font-size: 0.95em;">Ocorreu um problema ao carregar alguns componentes essenciais da aplicação. Por favor, tente as seguintes ações:</p>
      <ul style="text-align: left; margin: 0 auto 20px auto; padding-left: 20px; max-width: 300px; font-size: 0.9em;">
        <li style="margin-bottom: 8px;">Atualize a página (F5 ou Ctrl+R).</li>
        <li style="margin-bottom: 8px;">Limpe o cache do seu navegador.</li>
        <li style="margin-bottom: 8px;">Verifique sua conexão com a internet.</li>
        <li>Tente usar um navegador diferente (Chrome, Firefox, Edge).</li>
      </ul>
      <button id="retry-load-btn" style="
        background-color: #de350b;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1em;
        transition: background-color 0.2s ease;
      ">Tentar Carregar Novamente</button>
      <p style="margin-top: 20px; font-size: 0.8em; color: #5e6c84;">
        Se o problema persistir após tentar as soluções acima, por favor, contate o suporte técnico.
      </p>
    `;

    document.body.appendChild(errorDiv);

    // Adicionar evento ao botão para recarregar a página
    const retryButton = document.getElementById('retry-load-btn');
    if(retryButton) {
      retryButton.addEventListener('click', function() {
        errorDiv.remove();
        location.reload();
      });
      retryButton.onmouseover = () => retryButton.style.backgroundColor = '#bf2600';
      retryButton.onmouseout = () => retryButton.style.backgroundColor = '#de350b';
    }

    const loader = document.getElementById('global-loader');
    if (loader) loader.style.display = 'none';
  }
};

// Iniciar carregamento quando o DOM estiver pronto
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM carregado. Iniciando ScriptLoader.");
    ScriptLoader.init();
  });
} else {
  console.log("DOM já estava carregado. Iniciando ScriptLoader.");
  ScriptLoader.init();
}
</script>
</body>
</html>
