<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GrupoGPS Mecanizada - Sistema de Controle de Manutenção</title>

  <link rel="icon" href="data:,"> <!-- Favicon simples para evitar erro 404 -->

  <!-- Bibliotecas Externas (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <!-- Arquivos JS (Alguns carregados via ScriptLoader abaixo) -->
  <!-- advancedReports.js é carregado aqui, os outros via ScriptLoader -->
  <script src="js/advancedReports.js"></script> 

  <!-- Estilos CSS -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/enhanced-style.css">

</head>
<body>
  <div class="container">
    <!-- Cabeçalho -->
    <div class="header">
      <div class="company-logo">Grupo GPS</div>
      <h1>Sistema de Controle de Manutenção</h1>
    </div>

    <!-- Abas de Navegação -->
    <div class="tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="maintenance">Manutenções</div>
      <div class="tab" data-tab="verification">Verificações</div>
      <div class="tab" data-tab="reports">Relatórios</div>
    </div>

    <!-- Conteúdo da Aba Dashboard -->
    <div class="tab-content active" id="tab-dashboard">
      <div class="dashboard-header">
        <h2>Visão Geral</h2>
        <!-- Controles do Dashboard (Período, Refresh) serão adicionados aqui pelo dashboard.js -->
      </div>

      <div class="summary-cards">
        <div class="card">
          <div class="card-title"><i class="icon fas fa-clipboard-list"></i> Total de Manutenções</div>
          <div class="card-value" id="total-maintenance">0</div>
          <div class="card-footer"><span>Período selecionado</span></div>
        </div>
        <div class="card">
          <div class="card-title"><i class="icon fas fa-clock"></i> Aguardando Verificação</div>
          <div class="card-value" id="pending-verification">0</div>
          <div class="card-footer"><span>Precisa de atenção</span></div>
        </div>
        <div class="card">
          <div class="card-title"><i class="icon fas fa-check-circle"></i> Verificações Concluídas</div>
          <div class="card-value" id="completed-verifications">0</div>
          <div class="card-footer"><span>Período atual</span></div>
        </div>
        <div class="card">
          <div class="card-title"><i class="icon fas fa-exclamation-triangle"></i> Manutenções Críticas</div>
          <div class="card-value" id="critical-maintenance">0</div>
          <div class="card-footer"><span>Atenção necessária</span></div>
        </div>
      </div>

      <!-- Container Principal para Gráficos do Dashboard -->
      <div class="dashboard-grid">
         <!-- Gráficos serão renderizados aqui pelo dashboard.js -->
         <!-- Exemplos de placeholders que o JS pode usar: -->
         <div class="section chart-section" id="chart-maintenance-type-container">
             <h3 class="section-title">Manutenções por Tipo</h3>
             <div class="chart-container"><canvas id="maintenance-type-chart"></canvas></div>
         </div>
         <div class="section chart-section" id="chart-maintenance-status-container">
             <h3 class="section-title">Status das Manutenções</h3>
             <div class="chart-container"><canvas id="maintenance-status-chart"></canvas></div>
         </div>
         <div class="section chart-section" id="chart-area-distribution-container">
             <h4 class="section-title">Local de Manutenção</h4>
             <div class="chart-container"><canvas id="area-distribution-chart"></canvas></div>
         </div>
         <div class="section chart-section" id="chart-problem-categories-container">
             <h4 class="section-title">Categorias de Problemas</h4>
             <div class="chart-container"><canvas id="problem-categories-chart"></canvas></div>
         </div>
         <div class="section chart-section" id="chart-monthly-trend-container">
             <h4 class="section-title">Tendência Mensal</h4>
             <div class="chart-container"><canvas id="monthly-trend-chart"></canvas></div>
         </div>
         <div class="section chart-section" id="chart-critical-vs-regular-container">
             <h4 class="section-title">Manutenções Críticas vs Regulares</h4>
             <div class="chart-container"><canvas id="critical-vs-regular-chart"></canvas></div>
         </div>
         <div class="section chart-section" id="chart-verification-results-container">
             <h4 class="section-title">Resultados das Verificações</h4>
             <div class="chart-container"><canvas id="verification-results-chart"></canvas></div>
         </div>
         <div class="section chart-section" id="chart-maintenance-frequency-container">
             <h4 class="section-title">Intervalo entre Manutenções</h4>
             <div class="chart-container"><canvas id="maintenance-frequency-chart"></canvas></div>
         </div>
      </div>

      <div class="section">
        <h3 class="section-title">Equipamentos com Mais Manutenções</h3>
        <div class="table-responsive">
          <table id="equipment-ranking-table">
            <thead>
              <tr>
                <th>Equipamento</th> <th>Tipo</th> <th>Total Manutenções</th> <th>Última Manutenção</th> <th>Status</th>
              </tr>
            </thead>
            <tbody id="equipment-ranking-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">Manutenções Recentes</h3>
        <div class="table-responsive">
          <table id="recent-maintenance-table">
            <thead>
              <tr>
                <th>ID</th> <th>Equipamento</th> <th>Tipo</th> <th>Data Registro</th> <th>Responsável</th> <th>Status</th> <th>Ações</th>
              </tr>
            </thead>
            <tbody id="recent-maintenance-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Conteúdo da Aba Manutenções -->
    <div class="tab-content" id="tab-maintenance">
      <div class="section">
        <div class="search-container">
          <input type="text" class="search-input" id="maintenance-search" placeholder="Buscar por ID, equipamento, responsável...">
        </div>

        <!-- Container para Filtros de Manutenção -->
        <div class="filter-container" id="maintenance-filter-buttons">
          <!-- Filtros serão injetados aqui pelo maintenance.js -->
        </div>

        <h3 class="section-title">
          Lista de Manutenções
          <div class="section-actions">
            <button class="btn-icon" id="refresh-maintenance-list" title="Atualizar">↻</button>
            <!-- Botão "+" para Nova Manutenção será adicionado fixo no canto -->
          </div>
        </h3>

        <div class="table-responsive">
          <table id="maintenance-table">
            <thead>
              <tr>
                <th>ID</th> <th>Equipamento</th> <th>Tipo</th> <th>Data Registro</th> <th>Responsável</th> <th>Área</th> <th>Local/Oficina</th> <th>Problema</th> <th>Status</th> <th>Ações</th>
              </tr>
            </thead>
            <tbody id="maintenance-tbody">
              <!-- Linhas da tabela serão preenchidas pelo maintenance.js -->
            </tbody>
          </table>
        </div>
        <div class="pagination-controls" id="maintenance-pagination">
          <!-- Controles de paginação (se houver) -->
        </div>
      </div>
    </div>

    <!-- Conteúdo da Aba Verificações -->
    <div class="tab-content" id="tab-verification">
      <div class="section">
        <div class="search-container">
          <input type="text" class="search-input" id="verification-search" placeholder="Buscar por ID, equipamento, responsável...">
        </div>

        <!-- Container para Filtros de Verificação -->
        <div class="filter-container" id="verification-filter-buttons">
          <!-- Filtros podem ser adicionados aqui pelo verification.js -->
        </div>

        <h3 class="section-title">
          Verificações Pendentes
          <div class="section-actions">
            <button class="btn-icon" id="refresh-verification-list" title="Atualizar">↻</button>
          </div>
        </h3>

        <div class="table-responsive">
          <table id="verification-table">
            <thead>
              <tr>
                <th>ID</th> <th>Equipamento</th> <th>Tipo</th> <th>Data Manutenção</th> <th>Responsável</th> <th>Área</th> <th>Local/Oficina</th> <th>Status</th> <th>Ações</th>
              </tr>
            </thead>
            <tbody id="verification-tbody">
              <!-- Linhas da tabela serão preenchidas pelo verification.js -->
            </tbody>
          </table>
        </div>
        <div class="pagination-controls" id="verification-pagination">
          <!-- Controles de paginação (se houver) -->
        </div>
      </div>
    </div>

    <!-- Conteúdo da Aba Relatórios -->
    <div class="tab-content" id="tab-reports">
      <div class="section">
        <h3 class="section-title">Relatórios por Período</h3>
        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label for="report-start-date">Data Inicial</label>
              <input type="date" class="form-control" id="report-start-date">
            </div>
          </div>
          <div class="form-col">
            <div class="form-group">
              <label for="report-end-date">Data Final</label>
              <input type="date" class="form-control" id="report-end-date">
            </div>
          </div>
          <div class="form-col" style="display: flex; align-items: flex-end;">
            <button class="btn" id="generate-report">Gerar Relatório</button>
          </div>
        </div>
      </div>

      <!-- Conteúdo do Relatório Gerado -->
      <div id="report-content" style="display: none;">
        <div class="section">
          <h3 class="section-title">Resumo do Período</h3>
          <div class="summary-cards">
            <div class="card"><div class="card-title">Total</div><div class="card-value" id="report-total">0</div></div>
            <div class="card"><div class="card-title">Concluídas</div><div class="card-value" id="report-completed">0</div></div>
            <div class="card"><div class="card-title">Pendentes</div><div class="card-value" id="report-pending">0</div></div>
            <div class="card"><div class="card-title">Verificadas</div><div class="card-value" id="report-verified">0</div></div>
          </div>
        </div>
        <div class="section"><h3 class="section-title">Análise por Categoria</h3><div class="chart-container"><canvas id="report-problem-chart"></canvas></div></div>
        <div class="grid-container">
          <div class="section"><h3 class="section-title">Distribuição por Área</h3><div class="chart-container"><canvas id="report-area-chart"></canvas></div></div>
          <div class="section"><h3 class="section-title">Manutenções por Mês</h3><div class="chart-container"><canvas id="report-monthly-chart"></canvas></div></div>
        </div>
        <div class="section">
          <h3 class="section-title">Exportar Dados</h3>
          <div class="btn-action-group">
            <button class="btn" id="export-excel">Exportar para Excel</button>
            <button class="btn" id="export-pdf">Exportar para PDF</button>
            <button class="btn" id="print-report">Imprimir Relatório</button>
          </div>
        </div>
      </div>
    </div> <!-- Fim #tab-reports -->

    <!-- ======================= MODAIS ======================= -->

    <!-- Modal Formulário de Manutenção -->
    <div class="form-overlay" id="maintenance-form-overlay" style="display: none;"> <!-- Inicia escondido -->
      <div class="form-container" id="maintenance-form-modal"> <!-- Adicionado ID para referência -->
        <div class="form-header">
          <h2 class="form-title">Registrar Nova Manutenção</h2>
          <button class="form-close" id="close-maintenance-form" title="Fechar">×</button>
        </div>

        <!-- Indicadores de Etapa -->
        <div class="form-steps">
          <div class="form-step active" data-step="1"><div class="step-number">1</div><div class="step-label">Informações</div></div>
          <div class="form-step" data-step="2"><div class="step-number">2</div><div class="step-label">Problema</div></div>
          <div class="form-step" data-step="3"><div class="step-number">3</div><div class="step-label">Confirmar</div></div>
        </div>

        <form id="maintenance-form">
          <!-- Conteúdo Etapa 1 -->
          <div class="form-step-content" id="step-1-content">
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="equipment-type">Tipo de Equipamento <span class="form-required">*</span></label>
                  <select class="form-control" id="equipment-type" name="equipment-type" required>
                    <option value="">Selecione o tipo...</option>
                    <!-- Opções preenchidas pelo maintenance.js -->
                  </select>
                </div>
              </div>
              <div class="form-col"> <!-- Container do select de ID -->
                <div class="form-group">
                  <label for="equipment-id">Placa ou ID <span class="form-required">*</span></label>
                  <select class="form-control" id="equipment-id" name="equipment-id" disabled> <!-- Começa desabilitado -->
                    <option value="">Selecione o equipamento...</option>
                    <!-- Opções preenchidas pelo maintenance.js -->
                  </select>
                </div>
              </div>
            </div>
            <!-- Campo para equipamento 'Outro' (inicialmente escondido) -->
            <div class="form-group" id="other-equipment-field" style="display:none;">
              <label for="other-equipment">Especifique o Equipamento <span class="form-required">*</span></label>
              <input type="text" class="form-control" id="other-equipment" name="other-equipment">
            </div>
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="technician-name">Responsável pelo Relatório <span class="form-required">*</span></label>
                  <input type="text" class="form-control" id="technician-name" name="technician-name" required>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="maintenance-date">Data da Manutenção <span class="form-required">*</span></label>
                  <input type="date" class="form-control" id="maintenance-date" name="maintenance-date" required>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="area">Área <span class="form-required">*</span></label>
                  <select class="form-control" id="area" name="area" required>
                    <option value="">Selecione...</option>
                    <option value="Área Interna Usiminas">Área Interna Usiminas</option>
                    <option value="Área Externa Usiminas">Área Externa Usiminas</option>
                    <!-- Adicionar mais opções se necessário -->
                  </select>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group" id="office-field">
                  <label for="office">Local/Oficina <span class="form-required">*</span></label>
                  <input type="text" class="form-control" id="office" name="office" required>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="maintenance-type-select">Tipo de Manutenção <span class="form-required">*</span></label>
                  <select class="form-control" id="maintenance-type-select" name="maintenance-type-select" required>
                    <option value="">Selecione o tipo...</option>
                    <option value="Preventiva">Preventiva</option>
                    <option value="Corretiva">Corretiva</option>
                    <option value="Emergencial">Emergencial</option>
                    <option value="Melhoria">Melhoria</option>
                    <!-- Adicionar mais opções se necessário -->
                  </select>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <div class="form-check" style="padding-top: 30px;">
                    <input type="checkbox" id="is-critical" name="is-critical">
                    <label for="is-critical">Manutenção Crítica</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-navigation">
              <button type="button" class="btn btn-secondary" id="cancel-maintenance">Cancelar</button>
              <button type="button" class="btn btn-primary" id="next-to-step-2">Próximo <i class="fas fa-arrow-right"></i></button>
            </div>
          </div>

          <!-- Conteúdo Etapa 2 -->
          <div class="form-step-content" id="step-2-content" style="display: none;">
            <div class="form-group">
              <!-- Label corrigida para apontar para o ID do select -->
              <label for="problem-category-select">Categoria do Problema <span class="form-required">*</span></label>
              <select class="form-control" id="problem-category-select" name="problem-category-select" required>
                 <option value="">Selecione a categoria...</option>
                 <!-- Opções preenchidas pelo maintenance.js -->
              </select>
            </div>
            <!-- Campo para categoria 'Outros' (inicialmente escondido) -->
            <div class="form-group" id="other-category-field" style="display:none;">
              <label for="other-category">Especifique a Categoria <span class="form-required">*</span></label>
              <input type="text" class="form-control" id="other-category" name="other-category">
            </div>
            <div class="form-group">
              <label for="problem-description">Detalhes do Problema <span class="form-required">*</span></label>
              <textarea class="form-control" id="problem-description" name="problem-description" rows="4" required></textarea>
            </div>
            <div class="form-group">
              <label for="additional-notes">Observações Adicionais</label>
              <textarea class="form-control" id="additional-notes" name="additional-notes" rows="3"></textarea>
            </div>
            <div class="form-navigation">
              <button type="button" class="btn btn-secondary" id="back-to-step-1"><i class="fas fa-arrow-left"></i> Voltar</button>
              <button type="button" class="btn btn-primary" id="next-to-step-3">Próximo <i class="fas fa-arrow-right"></i></button>
            </div>
          </div>

          <!-- Conteúdo Etapa 3 -->
          <div class="form-step-content" id="step-3-content" style="display: none;">
            <div class="form-group">
              <h3>Resumo da Manutenção</h3>
              <div class="summary-content">
                <div class="summary-row"><div class="summary-label">Equipamento:</div><div class="summary-value" id="summary-equipment">-</div></div>
                <div class="summary-row"><div class="summary-label">Responsável:</div><div class="summary-value" id="summary-technician">-</div></div>
                <div class="summary-row"><div class="summary-label">Data:</div><div class="summary-value" id="summary-date">-</div></div>
                <div class="summary-row"><div class="summary-label">Local:</div><div class="summary-value" id="summary-location">-</div></div>
                <div class="summary-row"><div class="summary-label">Tipo:</div><div class="summary-value" id="summary-type">-</div></div>
                <div class="summary-row"><div class="summary-label">É Crítica:</div><div class="summary-value" id="summary-critical">-</div></div>
                <div class="summary-row"><div class="summary-label">Categoria:</div><div class="summary-value" id="summary-category">-</div></div>
                <div class="summary-row"><div class="summary-label">Problema:</div><div class="summary-value" id="summary-problem">-</div></div>
                <div class="summary-row"><div class="summary-label">Observações:</div><div class="summary-value" id="summary-notes">-</div></div>
              </div>
            </div>
            <div class="form-navigation">
              <button type="button" class="btn btn-secondary" id="back-to-step-2"><i class="fas fa-arrow-left"></i> Voltar</button>
              <button type="submit" class="btn btn-success" id="submit-maintenance"><i class="fas fa-check"></i> Finalizar Registro</button>
            </div>
          </div>
        </form>
      </div> <!-- Fim .form-container -->
    </div> <!-- Fim #maintenance-form-overlay -->

    <!-- Modal Formulário de Verificação -->
    <div class="form-overlay" id="verification-form-overlay" style="display: none;">
      <div class="form-container">
        <div class="form-header">
          <h2 class="form-title">Verificação de Manutenção</h2>
          <button class="form-close" id="close-verification-form" title="Fechar">×</button>
        </div>
        <form id="verification-form">
          <div class="form-group"><label for="verification-id">ID Manutenção</label><input type="text" class="form-control" id="verification-id" name="verification-id" readonly></div>
          <div class="form-row">
            <div class="form-col"><div class="form-group"><label for="verification-equipment">Equipamento</label><input type="text" class="form-control" id="verification-equipment" readonly></div></div>
            <div class="form-col"><div class="form-group"><label for="verification-type">Tipo Manutenção</label><input type="text" class="form-control" id="verification-type" readonly></div></div>
          </div>
          <div class="form-group">
            <label for="verifier-name">Nome do Verificador <span class="form-required">*</span></label>
            <input type="text" class="form-control" id="verifier-name" name="verifier-name" required>
          </div>
          <div class="form-group">
            <label>Resultado <span class="form-required">*</span></label>
            <div class="radio-group-container"> <!-- Container para validação visual dos radios -->
                <div class="form-check"><input type="radio" id="verification-approved" name="verification-result" value="Aprovado" required><label for="verification-approved">Aprovado</label></div>
                <div class="form-check"><input type="radio" id="verification-adjustments" name="verification-result" value="Ajustes" required><label for="verification-adjustments">Necessita Ajustes</label></div>
                <div class="form-check"><input type="radio" id="verification-rejected" name="verification-result" value="Reprovado" required><label for="verification-rejected">Reprovado</label></div>
            </div>
          </div>
          <div class="form-group">
            <label for="verification-comments">Comentários <span id="verification-comments-required" class="form-required" style="display:none;">*</span></label> <!-- '*' aparece condicionalmente -->
            <textarea class="form-control" id="verification-comments" name="verification-comments" rows="4"></textarea> <!-- Required é adicionado/removido via JS -->
          </div>
          <div class="form-navigation">
            <button type="button" class="btn btn-secondary" id="cancel-verification">Cancelar</button>
            <button type="submit" class="btn btn-success" id="submit-verification"><i class="fas fa-check"></i> Finalizar Verificação</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Detalhes da Manutenção (Fallback) -->
    <div class="form-overlay" id="detail-overlay" style="display: none;">
      <div class="modal-content-fallback"> <!-- Usando classe diferente para estilização específica se necessário -->
        <div class="form-header">
            <h2 class="form-title">Detalhes da Manutenção</h2>
            <button class="form-close close-modal-btn" title="Fechar">×</button> <!-- Classe genérica para fechar -->
        </div>
        <div class="maintenance-detail" id="maintenance-detail-content">
          <!-- Conteúdo dos detalhes será inserido aqui pelo JS -->
          <p>Carregando detalhes...</p>
        </div>
        <div class="modal-actions"> <!-- Container para botões de ação -->
          <!-- Botões (Fechar, Editar, Verificar) serão adicionados aqui pelo JS -->
          <button class="btn btn-secondary close-modal-btn">Fechar</button>
        </div>
      </div>
    </div>
    
    <!-- Modal Formulário de Verificação (FALLBACK - caso verification.js falhe) -->
    <div class="form-overlay" id="verification-form-overlay-fallback" style="display: none;">
        <div class="form-container">
            <div class="form-header">
                <h2 class="form-title">Verificação de Manutenção (Fallback)</h2>
                <button class="form-close" id="close-verification-form-fallback">×</button>
            </div>
            <form id="verification-form-fallback">
                <div class="form-group">
                    <label>ID Manutenção:</label>
                    <input type="text" class="form-control" id="verification-id-fallback" readonly>
                </div>
                <div class="form-group">
                    <label>Equipamento:</label>
                    <input type="text" class="form-control" id="verification-equipment-fallback" readonly>
                </div>
                 <div class="form-group">
                    <label>Tipo Manutenção:</label>
                    <input type="text" class="form-control" id="verification-type-fallback" readonly>
                </div>
                 <div class="form-group">
                    <label>Problema Registrado:</label>
                    <div id="verification-problem-display-fallback" style="padding: 8px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 4px; min-height: 40px;">-</div>
                </div>
                <div class="form-group" id="verifier-name-fallback-group"> <!-- Grupo para esconder se UserSession existir -->
                    <label for="verifier-name-fallback">Seu Nome <span class="form-required">*</span></label>
                    <input type="text" class="form-control" id="verifier-name-fallback" required>
                </div>
                <div class="form-group">
                    <label>Resultado <span class="form-required">*</span></label>
                    <div class="radio-group-container">
                        <div class="form-check"><input type="radio" id="vrf-approved" name="verification-result-fallback" value="Aprovado" required><label for="vrf-approved">Aprovado</label></div>
                        <div class="form-check"><input type="radio" id="vrf-adjustments" name="verification-result-fallback" value="Ajustes" required><label for="vrf-adjustments">Ajustes</label></div>
                        <div class="form-check"><input type="radio" id="vrf-rejected" name="verification-result-fallback" value="Reprovado" required><label for="vrf-rejected">Reprovado</label></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="verification-comments-fallback">Comentários <span class="form-required">* (se Ajustes ou Reprovado)</span></label>
                    <textarea class="form-control" id="verification-comments-fallback" rows="4"></textarea>
                </div>
                <div class="form-navigation">
                    <button type="button" class="btn btn-secondary" id="cancel-verification-fallback">Cancelar</button>
                    <button type="button" class="btn btn-success" id="submit-verification-btn-fallback">Registrar Verificação</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Container para Notificações (usado pelo fallback do Utilities) -->
    <div id="notification-container"></div>

    <!-- Botão Flutuante para Nova Manutenção -->
    <button class="btn-new" id="new-maintenance" title="Registrar Nova Manutenção">+</button>

    <!-- Rodapé -->
    <div class="footer">
      <p>Sistema de Controle de Manutenção © 2024 | Última atualização: <span id="last-update">Carregando...</span></p>
      <p class="developer-credit">Desenvolvido por Warlison Abreu</p>
    </div>
  </div> <!-- Fim .container -->

  <!-- Indicador de Loading Global (usado pelo fallback do Utilities) -->
  <div id="global-loader-fallback" style="display: none;">
    <div class="loader-spinner-fallback"></div>
    <div id="global-loader-message-fallback">Carregando...</div>
  </div>

  <!-- ScriptLoader e Configuração (ESSENCIAL) -->
  <script>
  // Configurações do sistema (mantido do seu exemplo)
  const scriptConfig = {
    baseUrl: '', // Base URL se os scripts não estiverem na raiz
    scripts: [
      {name: 'api', path: 'js/api.js', required: true},
      {name: 'utilities', path: 'js/utilities.js', required: true},
      {name: 'dashboard', path: 'js/dashboard.js', depends: ['api', 'utilities']},
      {name: 'maintenance', path: 'js/maintenance.js', depends: ['api', 'utilities']},
      {name: 'verification', path: 'js/verification.js', depends: ['api', 'utilities']},
      {name: 'reports', path: 'js/reports.js', depends: ['api', 'utilities']},
      {name: 'main', path: 'js/main.js', depends: ['api', 'utilities', 'dashboard', 'maintenance', 'verification', 'reports']} // Main depende de todos os outros módulos
    ],
    maxRetries: 3,  // Número de tentativas de recarga
    timeout: 15000  // Timeout em milissegundos (15s)
  };

  // Sistema de carregamento de scripts (mantido do seu exemplo)
  const ScriptLoader = {
    loadedScripts: {},
    pendingScripts: {},
    failedScripts: {}, // Para rastrear falhas persistentes

    init: function() {
      console.log("ScriptLoader: Iniciando carregamento das dependências...");
      this.loadCoreScriptsSequentially();
    },

    loadCoreScriptsSequentially: function() {
      const coreScripts = scriptConfig.scripts.filter(s => s.required);
      console.log("ScriptLoader: Carregando scripts essenciais sequencialmente...");

      this.loadScriptSequential(coreScripts, 0, true, () => {
        console.log("ScriptLoader: Scripts essenciais supostamente carregados.");
        // Verificar flags APÓS um pequeno delay para garantir execução dos scripts carregados
        setTimeout(() => {
          const apiOk = this.checkScriptLoaded('api');
          const utilsOk = this.checkScriptLoaded('utilities');

          if (!apiOk || !utilsOk) {
            console.error("ScriptLoader: Falha CRÍTICA ao carregar scripts essenciais (API ou Utilities). Abortando.");
            this.showErrorMessage("Falha ao carregar componentes essenciais (API/Utilities).");
            // Opcional: Esconder o loader se ele estiver visível
            const loader = document.getElementById('global-loader-fallback') || document.getElementById('global-loading-indicator');
            if (loader) loader.style.display = 'none';
            return; // Não prosseguir se essenciais falharam
          }
          console.log("ScriptLoader: Flags API_LOADED e UTILITIES_LOADED verificadas.");
          this.loadRemainingScripts();
        }, 150); // Delay para flags
      });
    },

    loadRemainingScripts: function() {
      const remainingScripts = scriptConfig.scripts.filter(s => !s.required);
      console.log("ScriptLoader: Carregando scripts restantes...");
      this.loadScriptSequential(remainingScripts, 0, false, () => {
        console.log("ScriptLoader: Todos os scripts carregados (ou tentativas esgotadas).");
        this.initializeSystem();
      });
    },

    loadScriptSequential: function(scripts, index, isCore, onComplete) {
      if (index >= scripts.length) {
        if (typeof onComplete === 'function') onComplete();
        return;
      }

      const script = scripts[index];
      console.log(`ScriptLoader: Tentando carregar ${isCore ? 'essencial' : 'restante'}: ${script.name}`);

      // Verificar dependências ANTES de carregar
      if (script.depends && script.depends.length > 0) {
        const dependenciesMet = script.depends.every(dep => {
          const loaded = this.checkScriptLoaded(dep);
          if (!loaded) console.warn(`ScriptLoader: Dependência '${dep}' para '${script.name}' ainda não carregada.`);
          return loaded;
        });

        if (!dependenciesMet) {
          console.warn(`ScriptLoader: Adiantando carregamento de '${script.name}' devido a dependências não resolvidas. Tentando novamente em breve.`);
          // Tenta novamente após um tempo
          setTimeout(() => this.loadScriptSequential(scripts, index, isCore, onComplete), 300);
          return;
        }
        console.log(`ScriptLoader: Dependências para '${script.name}' resolvidas.`);
      }

      this.loadScript(script.name, script.path)
        .then(() => {
           console.log(`ScriptLoader: Sucesso ao carregar '${script.name}'.`);
           setTimeout(() => this.loadScriptSequential(scripts, index + 1, isCore, onComplete), 50); // Pequeno delay antes do próximo
        })
        .catch(error => {
          console.error(`ScriptLoader: Erro final ao carregar '${script.name}':`, error.message);
          this.failedScripts[script.name] = true; // Marca como falho
          if (isCore) {
            console.error(`ScriptLoader: FALHA AO CARREGAR SCRIPT ESSENCIAL '${script.name}'. Abortando carregamento adicional.`);
             this.showErrorMessage(`Falha ao carregar o componente essencial '${script.name}'.`);
            // Não chama onComplete para parar o processo
          } else {
             console.warn(`ScriptLoader: Continuando carregamento apesar da falha em '${script.name}'.`);
             setTimeout(() => this.loadScriptSequential(scripts, index + 1, isCore, onComplete), 50); // Continua mesmo com erro não essencial
          }
        });
    },

    loadScript: function(name, path, retryCount = 0) {
      if (this.loadedScripts[name]) return Promise.resolve();
      if (this.pendingScripts[name]) return this.pendingScripts[name];
      if (this.failedScripts[name]) return Promise.reject(new Error(`Script '${name}' falhou ao carregar anteriormente.`));

      const url = scriptConfig.baseUrl + path;
      console.log(`ScriptLoader: Iniciando carregamento [Tentativa ${retryCount+1}] de: ${name} (${url})`);

      const promise = new Promise((resolve, reject) => {
        const scriptElement = document.createElement('script');
        scriptElement.src = `${url}?v=${new Date().getTime()}`; // Cache busting
        scriptElement.async = true;
        let timeoutId = null;

        const cleanup = (isSuccess) => {
          clearTimeout(timeoutId);
          scriptElement.onload = null;
          scriptElement.onerror = null;
           delete this.pendingScripts[name]; // Remove dos pendentes
          if (isSuccess) {
             this.loadedScripts[name] = true; // Marca como carregado
          }
          // Não remover o elemento script do DOM em caso de sucesso
          if (!isSuccess && scriptElement.parentNode) {
             scriptElement.remove();
          }
        };

        timeoutId = setTimeout(() => {
          console.error(`ScriptLoader: Timeout carregando ${name} (Tentativa ${retryCount + 1})`);
           if (retryCount < scriptConfig.maxRetries) {
             cleanup(false);
             setTimeout(() => this.loadScript(name, path, retryCount + 1).then(resolve).catch(reject), 300 * (retryCount + 1));
           } else {
             cleanup(false);
             reject(new Error(`Timeout: Falha ao carregar ${name} após ${scriptConfig.maxRetries + 1} tentativas.`));
           }
        }, scriptConfig.timeout);

        scriptElement.onload = () => {
          console.log(`ScriptLoader: Script ${name} carregado.`);
          // Adicionar verificação específica aqui se necessário (ex: window.API_LOADED)
          const loadedCorrectly = this.checkScriptLoaded(name); // Verifica flag ou objeto global
          if (loadedCorrectly) {
              cleanup(true);
              resolve();
          } else {
               console.warn(`ScriptLoader: Script ${name} carregado, mas verificação (flag/objeto) falhou.`);
               // Considerar como erro se a verificação falhar
               if (retryCount < scriptConfig.maxRetries) {
                 cleanup(false);
                 setTimeout(() => this.loadScript(name, path, retryCount + 1).then(resolve).catch(reject), 300 * (retryCount + 1));
               } else {
                 cleanup(false);
                 reject(new Error(`Verificação falhou para ${name} após ${scriptConfig.maxRetries + 1} tentativas.`));
               }
          }

        };

        scriptElement.onerror = (event) => {
          console.error(`ScriptLoader: Erro de rede/sintaxe carregando ${name} (Tentativa ${retryCount + 1})`, event);
           if (retryCount < scriptConfig.maxRetries) {
             cleanup(false);
             setTimeout(() => this.loadScript(name, path, retryCount + 1).then(resolve).catch(reject), 500 * (retryCount + 1));
           } else {
             cleanup(false);
             reject(new Error(`Erro de carregamento: Falha ao carregar ${name} após ${scriptConfig.maxRetries + 1} tentativas.`));
           }
        };

        document.body.appendChild(scriptElement);
      });

      this.pendingScripts[name] = promise;
      return promise;
    },

    // Função para verificar se o script carregou corretamente (verifica flags ou objetos globais)
    checkScriptLoaded: function(name) {
        switch(name) {
            case 'api': return typeof window.API !== 'undefined' && window.API_LOADED === true;
            case 'utilities': return typeof window.Utilities !== 'undefined' && window.UTILITIES_LOADED === true;
            case 'dashboard': return typeof window.Dashboard !== 'undefined';
            case 'maintenance': return typeof window.Maintenance !== 'undefined';
            case 'verification': return typeof window.Verification !== 'undefined';
            case 'reports': return typeof window.Reports !== 'undefined';
            case 'main': return typeof window.initializeApp === 'function'; // Ou outra verificação específica do main.js
            default: return this.loadedScripts[name] === true; // Fallback genérico
        }
    },

    initializeSystem: function() {
      console.log("ScriptLoader: Tentando inicializar o sistema via initializeApp...");
      const loaderIndicator = document.getElementById('global-loading-indicator');
      if (loaderIndicator) loaderIndicator.style.display = 'flex'; // Mostra loader

      // Adiciona um timeout para garantir que o navegador processe os scripts carregados
      setTimeout(() => {
          try {
            if (typeof initializeApp === 'function') {
              initializeApp(); // Chama a função global definida em main.js
              console.log("ScriptLoader: initializeApp() chamada com sucesso.");
            } else {
              console.error("ScriptLoader: Função global 'initializeApp' não encontrada após carregar scripts.");
              this.showErrorMessage("Falha ao iniciar a aplicação principal.");
            }
          } catch (error) {
            console.error("ScriptLoader: Erro GERAL durante a chamada de initializeApp:", error);
            this.showErrorMessage("Ocorreu um erro inesperado ao iniciar a aplicação.");
          } finally {
            // Esconde o loader após um tempo, mesmo se houver erro, para não travar a UI
            setTimeout(() => {
              if (loaderIndicator) loaderIndicator.style.display = 'none';
            }, 300);
          }
      }, 100); // Pequeno delay para inicialização
    },

    // Função para mostrar mensagem de erro (mantida do seu exemplo)
    showErrorMessage: function(customMessage = "Erro ao carregar componentes essenciais.") {
      if (document.getElementById('script-load-error-message')) return;
      const errorDiv = document.createElement('div');
      errorDiv.id = 'script-load-error-message';
      // Estilos (mantidos do seu exemplo)
      errorDiv.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #ffebe6; color: #bf2600; padding: 25px; border: 1px solid #ffbdad; border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.15); z-index: 10000; max-width: 90%; width: 450px; text-align: center; font-family: sans-serif;`;
      errorDiv.innerHTML = `
        <h2 style="color: #bf2600; margin-top: 0; margin-bottom: 15px; font-size: 1.3em;">Erro no Sistema</h2>
        <p style="margin-bottom: 20px; line-height: 1.5; font-size: 0.95em;">${customMessage}</p>
        <ul style="text-align: left; margin: 0 auto 20px auto; padding-left: 20px; max-width: 300px; font-size: 0.9em;">
          <li style="margin-bottom: 8px;">Atualize a página (F5 ou Ctrl+R).</li>
          <li style="margin-bottom: 8px;">Limpe o cache do navegador.</li>
          <li>Verifique sua conexão com a internet.</li>
        </ul>
        <button id="retry-load-btn" style="background-color: #de350b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 1em; transition: background-color 0.2s ease;">Recarregar Página</button>
        <p style="margin-top: 20px; font-size: 0.8em; color: #5e6c84;">Se o problema persistir, contate o suporte.</p>`;
      document.body.appendChild(errorDiv);
      const retryButton = document.getElementById('retry-load-btn');
      if(retryButton) {
        retryButton.addEventListener('click', () => location.reload());
        retryButton.onmouseover = () => retryButton.style.backgroundColor = '#bf2600';
        retryButton.onmouseout = () => retryButton.style.backgroundColor = '#de350b';
      }
       const loader = document.getElementById('global-loading-indicator'); // Esconde loader se erro aparecer
       if (loader) loader.style.display = 'none';
    }
  };

  // Iniciar carregamento quando o DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM carregado. Iniciando ScriptLoader.");
      ScriptLoader.init();
    });
  } else {
    console.log("DOM já estava carregado. Iniciando ScriptLoader.");
    ScriptLoader.init();
  }
  </script>

  <!-- ======================= NÃO HÁ MAIS SCRIPTS ABAIXO ======================= -->

</body>
</html>
