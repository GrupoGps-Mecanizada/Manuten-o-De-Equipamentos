<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GrupoGPS Mecanizada - Sistema de Dupla Checagem de Manuten√ß√£o</title>

  <link rel="icon" href="data:,">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="js/advancedReports.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">


  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/enhanced-style.css">

  </head>

<body>
  <div class="container">
    <div class="header">
      <div class="company-logo">Grupo GPS</div>
      <h1>Sistema de Controle de Manuten√ß√£o</h1>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="maintenance">Manuten√ß√µes</div>
      <div class="tab" data-tab="verification">Verifica√ß√µes</div>
      <div class="tab" data-tab="reports">Relat√≥rios</div>
    </div>

    <div class="tab-content active" id="tab-dashboard">
      <div class="dashboard-header">
        <h2>Vis√£o Geral</h2>
      </div>

      <!-- Se existisse um <div class="dashboard-controls">, o bloco abaixo seria inserido ap√≥s ele.
           Como n√£o existe no c√≥digo fornecido, ele ser√° inserido ap√≥s o dashboard-header. -->
      <!-- Painel de Filtros Inteligentes -->
      <div class="dashboard-filters">
        <input type="text" id="filter-search" placeholder="üîç Pesquisar..." />
        <select id="filter-status">
          <option value="">Todas as Situa√ß√µes</option>
          <option value="Pendente">Pendente</option>
          <option value="Conclu√≠do">Conclu√≠do</option>
          <option value="Cr√≠ticas">Cr√≠ticas</option>
          <option value="Ajustes">Ajustes</option>
        </select>
        <input type="date" id="filter-start-date" />
        <input type="date" id="filter-end-date" />
        <button id="filter-apply" class="btn btn-sm">Aplicar</button>
        <button id="filter-clear" class="btn btn-sm">Limpar</button>
      </div>

      <div class="summary-cards">
        <div class="card">
          <div class="card-title">
            <i class="icon fas fa-clipboard-list"></i> Total de Manuten√ß√µes
          </div>
          <div class="card-value" id="total-maintenance">0</div> <div class="card-footer">
            <span>Per√≠odo selecionado</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <i class="icon fas fa-clock"></i> Aguardando Verifica√ß√£o
          </div>
          <div class="card-value" id="pending-verification">0</div> <div class="card-footer">
            <span>Precisa de aten√ß√£o</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <i class="icon fas fa-check-circle"></i> Verifica√ß√µes Conclu√≠das
          </div>
          <div class="card-value" id="completed-verifications">0</div> <div class="card-footer">
            <span>Per√≠odo atual</span>
            </div>
        </div>

        <div class="card">
          <div class="card-title">
            <i class="icon fas fa-exclamation-triangle"></i> Manuten√ß√µes Cr√≠ticas
          </div>
          <div class="card-value" id="critical-maintenance">0</div> <div class="card-footer">
            <span>Aten√ß√£o necess√°ria</span>
          </div>
        </div>
      </div>

      <div class="grid-container">
        <div class="section">
          <h3 class="section-title">
            Manuten√ß√µes por Tipo
            </h3>
          <div class="chart-container">
            <canvas id="maintenance-type-chart"></canvas>
          </div>
        </div>

        <div class="section">
          <h3 class="section-title">
            Status das Manuten√ß√µes
            </h3>
          <div class="chart-container">
            <canvas id="maintenance-status-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">An√°lises Avan√ßadas</h3>

        <div class="grid-container">
          <div class="section sub-section">
            <h4 class="section-title">
              Local de Manuten√ß√£o
              </h4>
            <div class="chart-container">
              <canvas id="area-distribution-chart"></canvas>
            </div>
          </div>

          <div class="section sub-section">
            <h4 class="section-title">
              Categorias de Problemas
              </h4>
            <div class="chart-container">
              <canvas id="problem-categories-chart"></canvas>
            </div>
          </div>
        </div>

        <div class="grid-container">
          <div class="section sub-section">
            <h4 class="section-title">
              Tend√™ncia Mensal
             </h4>
            <div class="chart-container">
              <canvas id="monthly-trend-chart"></canvas>
            </div>
          </div>

          <div class="section sub-section">
            <h4 class="section-title">
              Manuten√ß√µes Cr√≠ticas vs Regulares
              </h4>
            <div class="chart-container">
              <canvas id="critical-vs-regular-chart"></canvas>
            </div>
          </div>
        </div>

        <div class="grid-container">
          <div class="section sub-section">
            <h4 class="section-title">
              Resultados das Verifica√ß√µes
              </h4>
            <div class="chart-container">
              <canvas id="verification-results-chart"></canvas>
            </div>
          </div>

          <div class="section sub-section">
            <h4 class="section-title">
              Intervalo entre Manuten√ß√µes
              </h4>
            <div class="chart-container">
              <canvas id="maintenance-frequency-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">
          Equipamentos com Mais Manuten√ß√µes
          </h3>
        <div class="table-responsive">
          <table id="equipment-ranking-table">
            <thead>
              <tr>
                <th>Equipamento</th>
                <th>Tipo</th>
                <th>Total Manuten√ß√µes</th>
                <th>√öltima Manuten√ß√£o</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="equipment-ranking-tbody">
              </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">Manuten√ß√µes Recentes</h3>
        <div class="table-responsive">
          <table id="recent-maintenance-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Equipamento</th>
                <th>Tipo</th>
                <th>Data Registro</th>
                <th>Respons√°vel</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="recent-maintenance-tbody">
              </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-maintenance">
        <div class="section">
           <div class="search-container">
             <input type="text" class="search-input" id="maintenance-search" placeholder="Buscar por ID, equipamento, respons√°vel...">
           </div>

           <div class="filter-container" id="maintenance-filter-buttons"> </div>

           <h3 class="section-title">
             Lista de Manuten√ß√µes
             <div class="section-actions">
               <button class="btn-icon" id="refresh-maintenance-list" title="Atualizar">‚Üª</button>
             </div>
           </h3>

           <div class="table-responsive">
             <table id="maintenance-table">
               <thead>
                 <tr>
                   <th>ID</th>
                   <th>Equipamento</th>
                   <th>Tipo</th>
                   <th>Data Registro</th>
                   <th>Respons√°vel</th>
                   <th>√Årea</th>
                   <th>Local/Oficina</th>
                   <th>Problema</th>
                   <th>Status</th>
                   <th>A√ß√µes</th>
                 </tr>
               </thead>
               <tbody id="maintenance-tbody">
                 </tbody>
             </table>
           </div>
           <div class="pagination-controls" id="maintenance-pagination">
              </div>
         </div>
    </div>

    <div class="tab-content" id="tab-verification">
       <div class="section">
          <div class="search-container">
            <input type="text" class="search-input" id="verification-search" placeholder="Buscar por ID, equipamento, respons√°vel...">
          </div>

          <div class="filter-container" id="verification-filter-buttons">
             </div>

          <h3 class="section-title">
            Verifica√ß√µes Pendentes
            <div class="section-actions">
              <button class="btn-icon" id="refresh-verification-list" title="Atualizar">‚Üª</button>
            </div>
          </h3>

          <div class="table-responsive">
            <table id="verification-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Equipamento</th>
                  <th>Tipo</th>
                  <th>Data Manuten√ß√£o</th>
                  <th>Respons√°vel</th>
                  <th>√Årea</th>
                  <th>Local/Oficina</th>
                  <th>Status</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="verification-tbody">
                </tbody>
            </table>
          </div>
           <div class="pagination-controls" id="verification-pagination">
              </div>
        </div>
    </div>

    <div class="tab-content" id="tab-reports">
       <div class="section">
         <h3 class="section-title">Relat√≥rios por Per√≠odo</h3>
         <div class="form-row">
           <div class="form-col">
             <div class="form-group">
               <label for="report-start-date">Data Inicial</label>
               <input type="date" class="form-control" id="report-start-date">
             </div>
           </div>
           <div class="form-col">
             <div class="form-group">
               <label for="report-end-date">Data Final</label>
               <input type="date" class="form-control" id="report-end-date">
             </div>
           </div>
           <div class="form-col" style="display: flex; align-items: flex-end;">
             <button class="btn" id="generate-report">Gerar Relat√≥rio</button>
           </div>
         </div>
       </div>

       <div id="report-content" style="display: none;">
         <div class="section">
           <h3 class="section-title">Resumo do Per√≠odo</h3>
           <div class="summary-cards">
             <div class="card">
               <div class="card-title">Total de Manuten√ß√µes</div>
               <div class="card-value" id="report-total">0</div>
             </div>
             <div class="card">
               <div class="card-title">Conclu√≠das</div>
               <div class="card-value" id="report-completed">0</div>
             </div>
             <div class="card">
               <div class="card-title">Pendentes</div>
               <div class="card-value" id="report-pending">0</div>
             </div>
             <div class="card">
               <div class="card-title">Verificadas</div>
               <div class="card-value" id="report-verified">0</div>
             </div>
           </div>
         </div>

         <div class="section">
           <h3 class="section-title">An√°lise por Categoria de Problema</h3>
           <div class="chart-container">
             <canvas id="report-problem-chart"></canvas>
           </div>
         </div>

         <div class="grid-container">
           <div class="section">
             <h3 class="section-title">Distribui√ß√£o por √Årea</h3>
             <div class="chart-container">
               <canvas id="report-area-chart"></canvas>
             </div>
           </div>

           <div class="section">
             <h3 class="section-title">Manuten√ß√µes por M√™s</h3>
             <div class="chart-container">
               <canvas id="report-monthly-chart"></canvas>
             </div>
           </div>
         </div>

         <div class="section">
           <h3 class="section-title">Exportar Dados</h3>
           <div class="btn-action-group">
             <button class="btn" id="export-excel">Exportar para Excel</button>
             <button class="btn" id="export-pdf">Exportar para PDF</button>
             <button class="btn" id="print-report">Imprimir Relat√≥rio</button>
           </div>
         </div>
       </div>
     </div>

    <div class="form-overlay" id="maintenance-form-overlay">
      <div class="form-container">
          <div class="form-header">
            <h2 class="form-title">Registrar Nova Manuten√ß√£o</h2>
            <button class="form-close" id="close-maintenance-form">√ó</button>
          </div>

          <div class="form-steps">
            <div class="form-step active" data-step="1">
              <div class="step-number">1</div>
              <div class="step-label">Informa√ß√µes</div>
            </div>
            <div class="form-step" data-step="2">
              <div class="step-number">2</div>
              <div class="step-label">Problema</div>
            </div>
            <div class="form-step" data-step="3">
              <div class="step-number">3</div>
              <div class="step-label">Confirmar</div>
            </div>
          </div>

          <form id="maintenance-form">
            <div class="form-step-content" id="step-1-content">
              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="equipment-type">Tipo de Equipamento <span class="form-required">*</span></label>
                    <select class="form-control" id="equipment-type" name="equipment-type" required>
                      <option value="">Selecione o tipo...</option>
                      </select>
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group">
                    <label for="equipment-id">Placa ou ID <span class="form-required">*</span></label>
                    <select class="form-control" id="equipment-id" name="equipment-id" required>
                      <option value="">Selecione o equipamento...</option>
                      </select>
                  </div>
                </div>
              </div>

              <div class="form-group" id="other-equipment-field" style="display:none;">
                <label for="other-equipment">Especifique Equipamento <span class="form-required">*</span></label>
                <input type="text" class="form-control" id="other-equipment" name="other-equipment">
              </div>

              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="technician-name">Respons√°vel pelo Relat√≥rio <span class="form-required">*</span></label>
                    <input type="text" class="form-control" id="technician-name" name="technician-name" required>
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group">
                    <label for="maintenance-date">Data da Manuten√ß√£o <span class="form-required">*</span></label>
                    <input type="date" class="form-control" id="maintenance-date" name="maintenance-date" required>
                  </div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="area">√Årea <span class="form-required">*</span></label>
                    <select class="form-control" id="area" name="area" required>
                      <option value="">Selecione...</option>
                      <option value="√Årea Interna Usiminas">√Årea Interna Usiminas</option>
                      <option value="√Årea Externa Usiminas">√Årea Externa Usiminas</option>
                    </select>
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group" id="office-field">
                    <label for="office">Local/Oficina <span class="form-required">*</span></label>
                    <input type="text" class="form-control" id="office" name="office" required>
                  </div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-col">
                  <div class="form-group">
                    <label for="maintenance-type-select">Tipo de Manuten√ß√£o <span class="form-required">*</span></label> <select class="form-control" id="maintenance-type-select" name="maintenance-type-select" required>
                      <option value="">Selecione o tipo...</option>
                      <option value="Preventiva">Preventiva</option>
                      <option value="Corretiva">Corretiva</option>
                      <option value="Emergencial">Emergencial</option>
                    </select>
                  </div>
                </div>
                <div class="form-col">
                  <div class="form-group">
                    <div class="form-check" style="padding-top: 30px;">
                      <input type="checkbox" id="is-critical" name="is-critical">
                      <label for="is-critical">Manuten√ß√£o Cr√≠tica (requer aten√ß√£o imediata)</label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-navigation">
                <button type="button" class="btn" id="cancel-maintenance">Cancelar</button>
                <button type="button" class="btn btn-success" id="next-to-step-2">Pr√≥ximo</button>
              </div>
            </div>

            <div class="form-step-content" id="step-2-content" style="display: none;">
              <div class="form-group">
                <label for="problem-category-select">Categoria do Problema <span class="form-required">*</span></label>
                <select class="form-control" id="problem-category-select" name="problem-category-select" required>
                  <option value="">Selecione a categoria...</option>
                  <!-- As op√ß√µes ser√£o injetadas pelo JS -->
                </select>
              </div>

              <div class="form-group" id="other-category-field" style="display:none;">
                <label for="other-category">Especifique Categoria <span class="form-required">*</span></label>
                <input type="text" class="form-control" id="other-category" name="other-category">
              </div>

              <div class="form-group">
                <label for="problem-description">Detalhes do Problema <span class="form-required">*</span></label>
                <textarea class="form-control" id="problem-description" name="problem-description" rows="4" required></textarea>
              </div>

              <div class="form-group">
                <label for="additional-notes">Observa√ß√µes Adicionais</label>
                <textarea class="form-control" id="additional-notes" name="additional-notes" rows="3"></textarea>
              </div>

              <div class="form-navigation">
                <button type="button" class="btn" id="back-to-step-1">Voltar</button>
                <button type="button" class="btn btn-success" id="next-to-step-3">Pr√≥ximo</button>
              </div>
            </div>

            <div class="form-step-content" id="step-3-content" style="display: none;">
              <div class="form-group">
                <h3>Resumo da Manuten√ß√£o</h3>
                <div class="summary-content">
                  <div class="summary-row">
                    <div class="summary-label">Equipamento:</div>
                    <div class="summary-value" id="summary-equipment"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Respons√°vel:</div>
                    <div class="summary-value" id="summary-technician"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Data:</div>
                    <div class="summary-value" id="summary-date"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Local:</div>
                    <div class="summary-value" id="summary-location"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Tipo:</div>
                    <div class="summary-value" id="summary-type"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">√â Cr√≠tica:</div>
                    <div class="summary-value" id="summary-critical"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Categoria de Problema:</div>
                    <div class="summary-value" id="summary-category"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Detalhes do Problema:</div>
                    <div class="summary-value" id="summary-problem"></div>
                  </div>
                  <div class="summary-row">
                    <div class="summary-label">Observa√ß√µes:</div>
                    <div class="summary-value" id="summary-notes"></div>
                  </div>
                </div>
              </div>

              <div class="form-navigation">
                <button type="button" class="btn" id="back-to-step-2">Voltar</button>
                <button type="submit" class="btn btn-success" id="submit-maintenance">Finalizar Registro</button>
              </div>
            </div>
          </form>
        </div>
    </div>

    <div class="form-overlay" id="verification-form-overlay">
      <div class="form-container">
          <div class="form-header">
            <h2 class="form-title">Verifica√ß√£o de Manuten√ß√£o</h2>
            <button class="form-close" id="close-verification-form">√ó</button>
          </div>

          <form id="verification-form">
            <div class="form-group">
              <label for="verification-id">ID da Manuten√ß√£o</label>
              <input type="text" class="form-control" id="verification-id" name="verification-id" readonly>
            </div>

            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="verification-equipment">Equipamento</label>
                  <input type="text" class="form-control" id="verification-equipment" readonly>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="verification-type">Tipo de Manuten√ß√£o</label>
                  <input type="text" class="form-control" id="verification-type" readonly>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="verifier-name">Nome do Verificador <span class="form-required">*</span></label>
              <input type="text" class="form-control" id="verifier-name" name="verifier-name" required>
            </div>

            <div class="form-group">
              <label>Resultado da Verifica√ß√£o <span class="form-required">*</span></label>
              <div class="form-check">
                <input type="radio" id="verification-approved" name="verification-result" value="Aprovado" required>
                <label for="verification-approved">Aprovado - Manuten√ß√£o Correta</label>
              </div>
              <div class="form-check">
                <input type="radio" id="verification-adjustments" name="verification-result" value="Ajustes" required>
                <label for="verification-adjustments">Necessita Ajustes Menores</label>
              </div>
              <div class="form-check">
                <input type="radio" id="verification-rejected" name="verification-result" value="Reprovado" required>
                <label for="verification-rejected">Reprovado - Precisa de Nova Manuten√ß√£o</label>
              </div>
            </div>

            <div class="form-group">
              <label for="verification-comments">Coment√°rios da Verifica√ß√£o <span class="form-required">*</span></label>
              <textarea class="form-control" id="verification-comments" name="verification-comments" rows="4" required></textarea>
            </div>

            <div class="form-navigation">
              <button type="button" class="btn" id="cancel-verification">Cancelar</button>
              <button type="submit" class="btn btn-success" id="submit-verification">Finalizar Verifica√ß√£o</button>
            </div>
          </form>
        </div>
    </div>

    <div class="form-overlay" id="detail-overlay">
      <div class="form-container">
          <div class="form-header">
            <h2 class="form-title">Detalhes da Manuten√ß√£o</h2>
            <button class="form-close" id="close-detail">√ó</button>
          </div>

          <div class="maintenance-detail" id="maintenance-detail-content">
            </div>

          <div class="form-navigation">
            <button class="btn" id="close-detail-btn">Fechar</button>
            <button class="btn btn-success" id="verify-maintenance-btn">Verificar Manuten√ß√£o</button>
          </div>
        </div>
    </div>

    <div id="notification-container"></div>

    <div class="btn-new" id="new-maintenance">+</div>

    <div class="footer">
      <p>Sistema de Dupla Checagem de Manuten√ß√£o ¬© 2025 | √öltima atualiza√ß√£o: <span id="last-update">Carregando...</span></p>
      <p class="developer-credit">Desenvolvido por Warlison Abreu</p>
    </div>
  </div>

  <div id="global-loader" style="display: none;">
    <div class="loader-spinner"></div>
    <div id="global-loader-message">Carregando...</div>
  </div>

<script>
// Configura√ß√µes do sistema
// Substitua a configura√ß√£o do scriptConfig no index.html
const scriptConfig = {
  baseUrl: '',
  scripts: [
    {name: 'api', path: 'js/api.js', required: true},
    {name: 'utilities', path: 'js/utilities.js', required: true},
    {name: 'dashboard', path: 'js/dashboard.js', depends: ['api', 'utilities']},
    {name: 'maintenance', path: 'js/maintenance.js', depends: ['api', 'utilities']},
    {name: 'verification', path: 'js/verification.js', depends: ['api', 'utilities']},
    {name: 'reports', path: 'js/reports.js', depends: ['api', 'utilities']},
    {name: 'main', path: 'js/main.js', depends: ['api', 'utilities']}
  ],
  maxRetries: 5,  // Aumentado o n√∫mero de tentativas
  timeout: 20000  // Aumentado o timeout para 20 segundos
};

// Sistema de carregamento de scripts com retentativas
const ScriptLoader = {
  loadedScripts: {},
  pendingScripts: {},

  init: function() {
    console.log("Iniciando carregamento das depend√™ncias...");
    // Primeiro carregar as depend√™ncias essenciais
    this.loadCoreScriptsSequentially();
  },

  loadCoreScriptsSequentially: function() {
    // Identificar scripts essenciais
    const coreScripts = scriptConfig.scripts.filter(s => s.required);

    console.log("Carregando scripts essenciais sequencialmente...");
    // Carregar primeiro script
    if (coreScripts.length > 0) {
      this.loadScriptSequential(coreScripts, 0, () => {
        console.log("Scripts essenciais carregados. Verificando flags...");

        // Verificar flags ap√≥s carregar todos os scripts essenciais
        setTimeout(() => {
          // Verificar se as flags est√£o definidas
          const apiLoaded = (window.API !== undefined) && window.API_LOADED;
          const utilitiesLoaded = (window.Utilities !== undefined) && window.UTILITIES_LOADED;

          if (!apiLoaded) {
            console.warn("API n√£o foi carregada corretamente!");
          }
          if (!utilitiesLoaded) {
            console.warn("Utilities n√£o foram carregadas corretamente!");
          }

          // Continuar mesmo com problemas (o sistema tentar√° recuperar)
          this.loadRemainingScripts();
        }, 100); // Pequeno timeout para garantir que flags sejam definidas
      });
    } else {
      this.loadRemainingScripts();
    }
  },

  loadScriptSequential: function(scripts, index, onComplete) {
    if (index >= scripts.length) {
      if (typeof onComplete === 'function') {
        onComplete();
      }
      return;
    }

    const script = scripts[index];
    console.log(`Carregando script essencial: ${script.name}`);

    this.loadScript(script.name, script.path)
      .then(() => {
        // Verifica se o script foi realmente carregado
        const scriptLoaded = this.checkScriptLoaded(script.name);
        if (!scriptLoaded) {
          console.warn(`Script ${script.name} n√£o foi carregado corretamente.`);
        }

        // Um pequeno intervalo para garantir que o script seja processado
        setTimeout(() => {
          this.loadScriptSequential(scripts, index + 1, onComplete);
        }, 100);
      })
      .catch(error => {
        console.error(`Erro ao carregar script essencial ${script.name}:`, error);
        // Continua mesmo com erro (menos cr√≠tico, o sistema tentar√° recuperar)
        setTimeout(() => {
          this.loadScriptSequential(scripts, index + 1, onComplete);
        }, 100);
      });
  },

  // Substitua a fun√ß√£o checkScriptLoaded no index.html
  checkScriptLoaded: function(name) {
    // Verifica se o script foi carregado corretamente
    if (name === 'api') {
      return window.API !== undefined && window.API_LOADED === true;
    } else if (name === 'utilities') {
      return window.Utilities !== undefined && window.UTILITIES_LOADED === true;
    }
    return this.loadedScripts[name] === true;
  },

  loadRemainingScripts: function() {
    // Filtrar scripts que n√£o s√£o essenciais
    const remainingScripts = scriptConfig.scripts.filter(s => !s.required);

    // Carregar scripts sequencialmente para garantir depend√™ncias
    console.log("Carregando scripts restantes...");
    this.loadScriptsSequentially(remainingScripts, 0, () => {
      console.log("Todos os scripts (essenciais e restantes) foram carregados.");
      this.initializeSystem();
    });
  },

  loadScriptsSequentially: function(scripts, index, onComplete) {
    if (index >= scripts.length) {
      if (typeof onComplete === 'function') {
        onComplete();
      }
      return;
    }

    const script = scripts[index];

    // Verificar depend√™ncias antes de tentar carregar
    if (script.depends && script.depends.length > 0) {
      const allDependenciesLoaded = script.depends.every(dep => {
        // Verifica explicitamente cada depend√™ncia
        if (dep === 'api' && !window.API) {
          console.warn("Depend√™ncia API n√£o est√° dispon√≠vel para " + script.name);
          return false;
        }
        if (dep === 'utilities' && !window.Utilities) {
          console.warn("Depend√™ncia Utilities n√£o est√° dispon√≠vel para " + script.name);
          return false;
        }
        return this.loadedScripts[dep];
      });

      if (!allDependenciesLoaded) {
        console.warn(`Depend√™ncias para ${script.name} n√£o est√£o carregadas. Adiando carregamento.`);
        // Adiar o carregamento e tentar novamente mais tarde
        setTimeout(() => {
          this.loadScriptsSequentially(scripts, index, onComplete);
        }, 300);
        return;
      }
    }

    this.loadScript(script.name, script.path)
      .then(() => {
        this.loadScriptsSequentially(scripts, index + 1, onComplete);
      })
      .catch((error) => {
        console.error(`Erro ao carregar script ${script.name}:`, error);
        // Continua carregando os outros scripts
        this.loadScriptsSequentially(scripts, index + 1, onComplete);
      });
  },

  loadScript: function(name, path, retryCount = 0) {
    // Se o script j√° foi carregado, retorne imediatamente.
    if (this.loadedScripts[name]) {
      return Promise.resolve();
    }

    // Se o script j√° est√° sendo carregado (pendente), retorne a promise existente.
    if (this.pendingScripts[name]) {
      return this.pendingScripts[name];
    }

    const url = scriptConfig.baseUrl + path;
    console.log(`Iniciando carregamento de: ${name} (${url})`);

    // Criar nova promise para carregar o script
    const promise = new Promise((resolve, reject) => {
      const scriptElement = document.createElement('script');
      scriptElement.src = url;
      scriptElement.async = true;

      let timeoutId = null;

      // Fun√ß√£o para limpar recursos
      const cleanup = () => {
        clearTimeout(timeoutId);
        scriptElement.onload = null;
        scriptElement.onerror = null;
      };

      // Configurar timeout
      timeoutId = setTimeout(() => {
        console.error(`Timeout ao carregar ${name} (${url}) ap√≥s ${scriptConfig.timeout}ms`);
        scriptElement.remove();
        delete this.pendingScripts[name];

        if (retryCount < scriptConfig.maxRetries) {
          console.log(`Tentando carregar ${name} novamente (tentativa ${retryCount + 1}/${scriptConfig.maxRetries})...`);
          this.loadScript(name, path, retryCount + 1)
            .then(resolve)
            .catch(reject);
        } else {
          cleanup();
          reject(new Error(`Falha ao carregar ${name} ap√≥s ${scriptConfig.maxRetries} tentativas (timeout)`));
        }
      }, scriptConfig.timeout);

      // Evento de sucesso
      scriptElement.onload = () => {
        console.log(`Script ${name} (${path}) carregado com sucesso.`);
        cleanup();
        this.loadedScripts[name] = true;
        delete this.pendingScripts[name];
        resolve();
      };

      // Evento de erro
      scriptElement.onerror = (event) => {
        console.error(`Erro ao carregar ${name} (${url})`, event);
        scriptElement.remove();
        delete this.pendingScripts[name];

        if (retryCount < scriptConfig.maxRetries) {
          console.log(`Tentando carregar ${name} novamente (tentativa ${retryCount + 1}/${scriptConfig.maxRetries})...`);
          setTimeout(() => {
            this.loadScript(name, path, retryCount + 1)
              .then(resolve)
              .catch(reject);
          }, 500 * (retryCount + 1));
        } else {
          cleanup();
          reject(new Error(`Falha ao carregar ${name} (${url}) ap√≥s ${scriptConfig.maxRetries} tentativas`));
        }
      };

      // Adicionar ao body para iniciar o carregamento
      document.body.appendChild(scriptElement);
    });

    // Armazena a promise enquanto o script est√° carregando
    this.pendingScripts[name] = promise;
    return promise;
  },

  initializeSystem: function() {
    console.log("Tentando inicializar o sistema...");
    const loader = document.getElementById('global-loader');
    if (loader) loader.style.display = 'flex';

    try {
      // Tenta chamar a fun√ß√£o global de inicializa√ß√£o
      if (typeof window.initializeApp === 'function') {
        window.initializeApp();
        console.log("Sistema inicializado via window.initializeApp().");
      } else if (typeof initializeApp === 'function') { // Fallback
        initializeApp();
        console.log("Sistema inicializado via initializeApp().");
      } else {
        console.error("Fun√ß√£o de inicializa√ß√£o 'initializeApp' n√£o encontrada. A aplica√ß√£o pode n√£o funcionar corretamente.");
        // Tentar inicializar componentes individuais como fallback
        this.initializeComponentsFallback();
      }
    } catch (error) {
      console.error("Erro GERAL durante a inicializa√ß√£o do sistema:", error);
      this.showErrorMessage();
    } finally {
      setTimeout(() => {
        if (loader) loader.style.display = 'none';
      }, 200);
    }
  },

  initializeComponentsFallback: function() {
    console.warn("Tentando inicializar componentes individuais como fallback...");
    let initializedSomething = false;

    // Tenta inicializar componentes comuns
    if (typeof Dashboard !== 'undefined' && typeof Dashboard.initialize === 'function') {
      try {
        Dashboard.initialize();
        console.log("Dashboard inicializado (fallback).");
        initializedSomething = true;
      } catch (e) { console.error("Erro ao inicializar Dashboard (fallback):", e); }
    }

    if (typeof Maintenance !== 'undefined' && typeof Maintenance.initialize === 'function') {
      try {
        Maintenance.initialize();
        console.log("Maintenance inicializado (fallback).");
        initializedSomething = true;
      } catch (e) { console.error("Erro ao inicializar Maintenance (fallback):", e); }
    }

    if (typeof Verification !== 'undefined' && typeof Verification.initialize === 'function') {
      try {
        Verification.initialize();
        console.log("Verification inicializado (fallback).");
        initializedSomething = true;
      } catch (e) { console.error("Erro ao inicializar Verification (fallback):", e); }
    }

    if (typeof Reports !== 'undefined' && typeof Reports.initialize === 'function') {
      try {
        Reports.initialize();
        console.log("Reports inicializado (fallback).");
        initializedSomething = true;
      } catch (e) { console.error("Erro ao inicializar Reports (fallback):", e); }
    }

    if (!initializedSomething) {
      console.error("Nenhum componente p√¥de ser inicializado via fallback.");
      this.showErrorMessage();
    }
  },

  showErrorMessage: function() {
    // Garante que n√£o haja m√∫ltiplas mensagens de erro
    if (document.getElementById('script-load-error-message')) {
      return;
    }

    // Criar mensagem de erro vis√≠vel
    const errorDiv = document.createElement('div');
    errorDiv.id = 'script-load-error-message';
    errorDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #ffebe6;
      color: #bf2600;
      padding: 25px;
      border: 1px solid #ffbdad;
      border-radius: 8px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      z-index: 10000;
      max-width: 90%;
      width: 450px;
      text-align: center;
      font-family: sans-serif;
    `;

    errorDiv.innerHTML = `
      <h2 style="color: #bf2600; margin-top: 0; margin-bottom: 15px; font-size: 1.3em;">Erro ao Carregar o Sistema</h2>
      <p style="margin-bottom: 20px; line-height: 1.5; font-size: 0.95em;">Ocorreu um problema ao carregar alguns componentes essenciais da aplica√ß√£o. Por favor, tente as seguintes a√ß√µes:</p>
      <ul style="text-align: left; margin: 0 auto 20px auto; padding-left: 20px; max-width: 300px; font-size: 0.9em;">
        <li style="margin-bottom: 8px;">Atualize a p√°gina (F5 ou Ctrl+R).</li>
        <li style="margin-bottom: 8px;">Limpe o cache do seu navegador.</li>
        <li style="margin-bottom: 8px;">Verifique sua conex√£o com a internet.</li>
        <li>Tente usar um navegador diferente (Chrome, Firefox, Edge).</li>
      </ul>
      <button id="retry-load-btn" style="
        background-color: #de350b;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1em;
        transition: background-color 0.2s ease;
      ">Tentar Carregar Novamente</button>
      <p style="margin-top: 20px; font-size: 0.8em; color: #5e6c84;">
        Se o problema persistir ap√≥s tentar as solu√ß√µes acima, por favor, contate o suporte t√©cnico.
      </p>
    `;

    document.body.appendChild(errorDiv);

    // Adicionar evento ao bot√£o para recarregar a p√°gina
    const retryButton = document.getElementById('retry-load-btn');
    if(retryButton) {
      retryButton.addEventListener('click', function() {
        errorDiv.remove();
        location.reload();
      });
      retryButton.onmouseover = () => retryButton.style.backgroundColor = '#bf2600';
      retryButton.onmouseout = () => retryButton.style.backgroundColor = '#de350b';
    }

    const loader = document.getElementById('global-loader');
    if (loader) loader.style.display = 'none';
  }
};

// Iniciar carregamento quando o DOM estiver pronto
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM carregado. Iniciando ScriptLoader.");
    ScriptLoader.init();
  });
} else {
  console.log("DOM j√° estava carregado. Iniciando ScriptLoader.");
  ScriptLoader.init();
}
</script>

<script>
// PATCH DE EMERG√äNCIA - Adicione este script direto ao final do HTML, antes do </body>
document.addEventListener('DOMContentLoaded', function() {
    console.log("PATCH EMERGENCIAL APLICADO");

    // Refer√™ncias aos elementos principais
    const typeSelect = document.getElementById('equipment-type');
    const equipmentIdContainer = document.getElementById('equipment-id').closest('.form-col, .form-group');
    const otherEquipmentField = document.getElementById('other-equipment-field');

    // Verificar DOM antes de manipular
    if (!typeSelect || !equipmentIdContainer || !otherEquipmentField) {
        console.error("ERRO: Elementos cr√≠ticos n√£o encontrados!", {
            typeSelect: !!typeSelect,
            equipmentIdContainer: !!equipmentIdContainer,
            otherEquipmentField: !!otherEquipmentField
        });
        alert("Erro ao carregar o formul√°rio. Tente recarregar a p√°gina.");
        return;
    }

    // LISTAS HARDCODED para carregar em caso de falha
    const equipmentLists = {
        "Alta Press√£o": ["PUB-2G02","LUX-3201","FLX7617","EZS-8765","EZS-8764","EVK-0291","EOF-5C06",
                          "EOF-5208","EGC-2989","EGC-2985","EGC-2983","EGC-2978","EAM-3262","EAM-3256",
                          "EAM-3255","EAM-3253","EAM-3010","DSY-6475","DSY-6474","DSY-6472","CZC-0453"],
        "Auto V√°cuo / Hiper V√°cuo": ["PUB-2F80","NFF-0235","HJS-1097","FSA-3D71","EGC-2993","EGC-2979",
                                     "EAM-3257","EAM-3251","DYB-7210","DSY-6577","DSY-6473","CUB-0763",
                                     "ANF-2676","FTW-4D99","FTD-6368","FMD-2200","FHD-9264","EZS-9753"]
    };

    // Fun√ß√£o de manipula√ß√£o direta
    function handleTypeChange() {
        const selectedValue = typeSelect.value;
        const selectedText = typeSelect.options[typeSelect.selectedIndex].text;
        console.log(`PATCH: Tipo selecionado: '${selectedText}' (valor: '${selectedValue}')`);

        // Esconder todos os campos primeiro
        equipmentIdContainer.style.display = 'none';
        otherEquipmentField.style.display = 'none';

        // Determinar qual campo mostrar
        if (selectedText === 'Alta Press√£o' || selectedText === 'Auto V√°cuo / Hiper V√°cuo' ||
            selectedValue === 'alta-pressao' || selectedValue === 'auto-vacuo-hiper-vacuo') {
            // Mostrar e preencher o dropdown de equipamentos
            equipmentIdContainer.style.display = 'block';

            const equipmentIdSelect = document.getElementById('equipment-id');
            equipmentIdSelect.innerHTML = '<option value="">Carregando equipamentos...</option>';

            // Usar lista hardcoded apropriada
            let equipmentList = [];
            if (selectedText === 'Alta Press√£o' || selectedValue === 'alta-pressao') {
                equipmentList = equipmentLists["Alta Press√£o"];
            } else {
                equipmentList = equipmentLists["Auto V√°cuo / Hiper V√°cuo"];
            }

            // Preencher o select
            equipmentIdSelect.innerHTML = '<option value="">Selecione o equipamento...</option>';
            equipmentList.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                equipmentIdSelect.appendChild(option);
            });
            equipmentIdSelect.disabled = false;
            equipmentIdSelect.setAttribute('required', 'required');

            console.log(`PATCH: Campo de equipamento mostrado com ${equipmentList.length} itens`);
        }
        else if (selectedText === 'Aspirador' || selectedText === 'Poliguindaste' || selectedText === 'Outro' ||
                selectedValue === 'aspirador' || selectedValue === 'poliguindaste' || selectedValue === 'outro') {
            // Mostrar campo de entrada manual
            otherEquipmentField.style.display = 'block';
            const otherEquipmentInput = document.getElementById('other-equipment');
            if (otherEquipmentInput) {
                otherEquipmentInput.setAttribute('required', 'required');
                otherEquipmentInput.focus();
            }
            console.log("PATCH: Campo de entrada manual mostrado");
        }
    }

    // Remover listeners existentes e adicionar novo
    const newTypeSelect = typeSelect.cloneNode(true);
    typeSelect.parentNode.replaceChild(newTypeSelect, typeSelect);

    // Adicionar novo listener e executar imediatamente para configurar o estado inicial
    newTypeSelect.addEventListener('change', handleTypeChange);
    console.log("PATCH: Novo listener adicionado ao select de tipo de equipamento");

    // Se j√° tiver um valor selecionado, executar o handler agora
    if (newTypeSelect.value) {
        setTimeout(handleTypeChange, 100);
    }
});
</script>

<!-- Adicionar loader global -->
<div id="global-loading-indicator" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column;">
  <div class="loader-spinner" style="width: 50px; height: 50px; border: 5px solid rgba(0, 82, 204, 0.2); border-radius: 50%; border-top-color: #0052cc; animation: spin 1s ease-in-out infinite;"></div>
  <div id="global-loader-message" style="margin-top: 15px; color: #172b4d; font-weight: 500;">Carregando...</div>
</div>
<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
<!-- Adicionar container para gr√°ficos do dashboard -->
<div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin: 1.5rem 0;"></div>

<!-- Container para o formul√°rio de manuten√ß√£o -->
<div id="maintenance-form-container"></div>

<!-- ARQUIVO: index.html -->
<!-- ADICIONAR: antes do </body> -->
<script>
// PATCH DE CORRE√á√ÉO PARA FORMUL√ÅRIO
document.addEventListener('DOMContentLoaded', function() {
  console.log("Aplicando patch de corre√ß√£o para formul√°rio de manuten√ß√£o");
  
  // Adiciona listener ao bot√£o de nova manuten√ß√£o para tentar carregar o formul√°rio manualmente
  const newMaintenanceBtn = document.getElementById('new-maintenance');
  if (newMaintenanceBtn) {
    // Preservar o handler original
    const originalClickHandler = newMaintenanceBtn.onclick;
    
    // Substituir por nosso handler melhorado
    newMaintenanceBtn.onclick = function(e) {
      if (originalClickHandler) originalClickHandler.call(this, e);
      
      // Verificar se o modal est√° vis√≠vel ap√≥s um pequeno delay
      setTimeout(() => {
        const modal = document.getElementById('maintenance-form-overlay');
        if (!modal || modal.style.display !== 'flex') {
          console.log("Tentando abrir formul√°rio via patch...");
          
          // Tentativa de carregar e mostrar o formul√°rio
          if (window.Maintenance && typeof Maintenance.openMaintenanceForm === 'function') {
            Maintenance.openMaintenanceForm();
          }
        }
      }, 500);
    };
  }
});
</script>
</body>
</html>
